<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <title>Copying a subset of a document library to another SharePoint tenants with resume functionality | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="Copying a subset of a document library to another SharePoint tenants with resume functionality | PnP Samples ">
    <meta name="generator" content="docfx 2.56.7.0">
    <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Copying a subset of a document library to another SharePoint tenants with resume functionality | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
    <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>    </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/spo-copy-library-across-tenants/README.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="copying-a-subset-of-a-document-library-to-another-sharepoint-tenants-with-resume-functionality">Copying a subset of a document library to another SharePoint tenants with resume functionality</h1>

<h2 id="summary">Summary</h2>
<p>You might have the case to copy a subset of document library from one tenant to another one.
This examples</p>
<ul>
<li>containes resume functionality, especially when dealing with huge libraries</li>
<li>select subset of files based on a meta data property value</li>
<li>specify additional meta data columns to copy to target library</li>
<li>creates necessary folder structure in target library</li>
<li>creates a logfile with file copy status</li>
</ul>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>An EntraId app for each source and target tenant, either with app-only or delegated permissions to access the specific site</li>
<li>Installed PowerShell modules PnP.PowerShell and ImportExcel</li>
</ul>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_pnpps" role="tab" aria-controls="tabpanel_CeZOj-G++Q_pnpps" data-tab="pnpps" tabindex="0" aria-selected="true">PnP PowerShell</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_pnpps" role="tabpanel" data-tab="pnpps">

<pre><code class="lang-PowerShell">
# Install the necessary module
#Install-Module -Name ImportExcel -Scope CurrentUser
#Install-Module PnP.PowerShell -Scope CurrentUser


###################
### User Config ###
###################

$sourceSite = &quot;https://contoso.sharepoint.com/sites/source-site&quot;
$sourceLibrary = &quot;SourceDocLib&quot;
$sourceDataQueryProperty = &quot;&lt;filter property&gt;&quot;
$sourceDataQueryPropertyValue = &quot;&lt;filter property value&gt;&quot;

$sourceAppId = &quot;&lt;source app id&gt;&quot;
$sourceTenantId = &quot;&lt;source tenant id&gt;&quot;
$sourceCertThumb =&quot;&lt;source cert thumb&gt;&quot;


$targetSite = &quot;https://fabrikam.sharepoint.com/sites/target-site&quot;
$targetLibrary = &quot;TargetDocLib&quot;

$targetAppId = &quot;&lt;target app id&gt;&quot;
$targetTenantId = &quot;&lt;target tenant id&gt;&quot;
$targetCertThumb = &quot;&lt;target cert thumb&gt;&quot;

$propertiesToMigrate = @('&lt;ColumnName1&gt;', '&lt;ColumnName2&gt;') # List of internal properties to migrate

$sourceCtx = Connect-PnPOnline -Url $sourceSite -ClientId $sourceAppId -Tenant $sourceTenantId -Thumbprint $sourceCertThumb -ReturnConnection
$targetCtx = Connect-PnPOnline -Url $targetSite -ClientId $targetAppId -Tenant $targetTenantId -Thumbprint $targetCertThumb -ReturnConnection

# Alternative for interactive login
#$sourceCtx = Connect-PnPOnline -Url $sourceSite -ClientId $sourceAppId -Tenant $sourceTenantId -Interactive -ReturnConnection
#$targetCtx = Connect-PnPOnline -Url $targetSite -ClientId $targetAppId -Tenant $targetTenantId -Interactive -ReturnConnection

###############
### Helpers ###
###############

# # Create fields in target library
# foreach ($property in $propertiesToMigrate) {
#     Add-PnPField -Type Text -InternalName $property -DisplayName $property -Group &quot;EHS&quot; -Connection $targetCtx
# }

###############################################
###############################################
#### DO NOT CHANGE ANYTHING BELOW THIS LINE ###
###############################################
###############################################

function GetFileCopyLog
{
    param(
        [Parameter(Mandatory=$true)]
        [string]$PathToFileCopyLog
    )

    if (-not (Test-Path $PathToFileCopyLog -PathType Leaf)) {
        
        $ListItemQuery = &quot;&lt;View Scope='RecursiveAll'&gt;&lt;Query&gt;&lt;Where&gt;&lt;Eq&gt;&lt;FieldRef Name='$($sourceDataQueryProperty)'/&gt;&lt;Value Type='Text'&gt;$($sourceDataQueryPropertyValue)&lt;/Value&gt;&lt;/Eq&gt;&lt;/Where&gt;&lt;/Query&gt;&lt;/View&gt;&quot;
        $allItemsToCopy = (Get-PnPListItem -List $sourceLibrary -Query $ListItemQuery -PageSize 1000 -Connection $sourceCtx).FieldValues

        $sourceList = Get-PnPList -Identity $sourceLibrary -Connection $sourceCtx
        
        foreach ($currentItem in $allItemsToCopy) {
            # Write log
            [PSCustomObject]@{
                Filename = $currentItem.FileLeafRef
                UniqueId = $currentItem.UniqueId
                SourceItemId = $currentItem.ID
                SourceFileRef = $currentItem.FileRef
                SourceFileDirRef = $currentItem.FileDirRef
                SourceFileDirRefRelative = $currentItem.FileDirRef.Replace($sourceList.RootFolder.ServerRelativeUrl, $sourceLibrary)
                TargetFileDirRefRelative = $currentItem.FileDirRef.Replace($sourceList.RootFolder.ServerRelativeUrl, $targetLibrary)
                CopiedProperties = &quot;&quot;
                Status = &quot;Not copied&quot;
            } | Export-Excel $PathToFileCopyLog -Append
        }
    }
}


function CreateFoldersInTarget
{
    param(
        [Parameter(Mandatory=$true)]
        [string]$PathToFileCopyLog
    )

    # Read file with folders
    $logFile = Import-Excel -Path $PathToFileCopyLog

    # Get unique folders
    $uniqueFolders = $logFile.TargetFileDirRefRelative | Sort-Object -Unique

    # Create folder structure in target
    Write-Host -ForegroundColor White &quot;Creating folders in target: $($uniqueFolders.Count)&quot;
    foreach ($folder in $uniqueFolders) {
        Write-Host -ForegroundColor White &quot;Creating folder: $($folder)&quot;
        $folderResult = Resolve-PnPFolder -SiteRelativePath $folder -Connection $targetCtx
    }
    Write-Host -ForegroundColor Green &quot;DONE&quot;
}


function Copy-Files
{
    param(
        [Parameter(Mandatory=$true)]
        [string]$PathToFileCopyLog
    )

    # Read file with folders
    $logFile = Import-Excel -Path $PathToFileCopyLog

    $itemsToCopy = $logFile | Where-Object { $_.Status -ne &quot;Copied&quot; }

    Write-Host -ForegroundColor White &quot;Starting copy of files: $($itemsToCopy.Count)&quot;

    $counter = 0
    foreach ($itemToCopy in $itemsToCopy) {
        $counter++
        Write-Host -ForegroundColor White &quot;Copy job '$($counter)/$($itemsToCopy.Count)': $($itemToCopy.Filename)&quot;

        # Read properties
        $fileAsListItem = $null
        $fileAsListItem = Get-PnPListItem -List $sourceLibrary -UniqueId $itemToCopy.UniqueId -Connection $sourceCtx

        # Read file
        $fileAsMemStream = $null
        $fileAsMemStream = Get-PnPFile -Url $itemToCopy.SourceFileRef -AsMemoryStream -Connection $sourceCtx

        # Get item properties from source
        $propertiesHashtable = @{}
        $propertiesAsString = $null
        foreach($prop in $propertiesToMigrate){
            $propertiesHashtable[$prop] = $fileAsListItem.FieldValues.$prop
            $propertiesAsString = $propertiesAsString,&quot;$($prop)=$($fileAsListItem.FieldValues.$prop)&quot; -join ','
        }
    
        # Create file in target with properties
        $copyStatus = $null
        try {
            $result = Add-PnPFile -Folder $itemToCopy.TargetFileDirRefRelative -FileName $itemToCopy.Filename -Stream $fileAsMemStream -Values $propertiesHashtable -Connection $targetCtx
            $copyStatus = &quot;Copied&quot;
        }
        catch {
            $copyStatus = &quot;Error&quot;
        }
        
        # Udate the status in the file copy log
        $itemToCopy.Status = $copyStatus
        $itemToCopy.CopiedProperties = $propertiesAsString
        $logFile | Export-Excel -Path $PathToFileCopyLog
    }
    return $null
}

#######################
#######################

Write-Host -ForegroundColor Green &quot;Starting file copy job&quot;

$jobstart = Get-Date 

# Define logging file
$FileCopyLog = &quot;$PSScriptRoot\CopyLibraryBetweenTenants-FileCopyLog.xlsx&quot;

GetFileCopyLog -PathToFileCopyLog $FileCopyLog

CreateFoldersInTarget -PathToFileCopyLog $FileCopyLog

Copy-Files -PathToFileCopyLog $FileCopyLog

$jobend = Get-Date

$jobduration = New-TimeSpan -Start $jobstart -End $jobend

Write-Host -ForegroundColor White &quot;&quot;
Write-Host -ForegroundColor White &quot;Job duration: '$($jobduration.Hours)'h '$($jobduration.Minutes)'min '$($jobduration.Seconds)'sec (system time: '$($jobduration)')&quot;

Write-Host -ForegroundColor Green &quot;DONE&quot;

</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>PnP PowerShell</strong> to learn more at: <a href="https://aka.ms/pnp/powershell">https://aka.ms/pnp/powershell</a></p>
</div>
<div class="highlight-tool">
<p>The way you login into PnP PowerShell has changed please read <a href="https://github.com/pnp/powershell/discussions/4249">PnP Management Shell EntraID app is deleted : what should I do ?</a></p>
</div>
</section>
</div>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Timo Vomstein</td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/spo-copy-library-across-tenants" aria-hidden="true">
</article>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    
    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>