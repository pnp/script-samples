<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Export OneDrive Admins | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="Export OneDrive Admins | PnP Samples ">
    <meta name="generator" content="docfx ">
  <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">

    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Export OneDrive Admins | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
  <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">

    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.min.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
  
  
  <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/onedrive-export-admins/README.md/#L1" title="Edit this page" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
  <h1 id="export-onedrive-admins">Export OneDrive Admins</h1>

<h2 id="summary">Summary</h2>
<p>Have you ever needed to know which Admins have added themselves to which OneDrives? This script exports every OneDrive in the tenant, and the site collection admins of the site. This helps audit which admins have unnecessary access to user OneDrives. Once you have the report, you can identify unnecessary access by filtering in Excel.</p>
<p><img src="assets/OneDriveAdmins.png" alt="Example Screenshot"></p>
<p>The report produces a csv file with one row per Site Collection Admin and OneDrive. This report has four columns:
SiteURL
SiteName
SiteCollectionAdmin
SiteCollectionAdminName</p>
<div class="tabGroup" id="tabgroup_1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_1_pnppsv2" role="tab" aria-controls="tabpanel_1_pnppsv2" data-tab="pnppsv2" tabindex="0" aria-selected="true">PnP PowerShell v2</a>
</li>
<li role="presentation">
<a href="#tabpanel_1_pnpps" role="tab" aria-controls="tabpanel_1_pnpps" data-tab="pnpps" tabindex="-1">PnP PowerShell</a>
</li>
</ul>
<section id="tabpanel_1_pnppsv2" role="tabpanel" data-tab="pnppsv2">
<h2 id="parameters--configuration">Parameters / Configuration</h2>
<p>Customize the following values:</p>
<ul>
<li><strong>AdminURL</strong> – SharePoint Admin Center URL</li>
<li><strong>ClientId</strong> – Azure AD App Client ID</li>
<li><strong>Thumbprint</strong> – Certificate thumbprint</li>
<li><strong>Tenant</strong> – Tenant domain (e.g., contoso.onmicrosoft.com)</li>
<li><strong>OutputFile</strong> – Path to export the CSV</li>
</ul>
<h2 id="output-details">Output Details</h2>
<p>The CSV output file will contain the following values:</p>
<ul>
<li><strong>SiteURL</strong> – URL of the OneDrive site</li>
<li><strong>SiteName</strong> – Name of the OneDrive site</li>
<li><strong>SiteCollectionAdmin</strong> – Admin email address</li>
<li><strong>SiteCollectionAdminName</strong> – Admin display name</li>
</ul>
<h2 id="real-world-scenarios--use-cases">Real-World Scenarios / Use Cases</h2>
<ul>
<li>Auditing OneDrive admins after an internal restructure or staff departures</li>
<li>Ensuring compliance and least-privilege access policies</li>
<li>Preparing for internal or external security audits</li>
</ul>
<h2 id="notes--tips">Notes / Tips</h2>
<ul>
<li>For large tenants, consider running in PowerShell 7 for better performance</li>
<li>CSV can be filtered in Excel to quickly identify unnecessary or excessive access</li>
<li>The script is <strong>read-only</strong>; it does not modify permissions</li>
</ul>
<pre><code class="lang-powershell">
# Parameters
$AdminURL = &quot;https://contoso-admin.sharepoint.com&quot;
$ClientId = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;
$Thumbprint = &quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
$Tenant = &quot;contoso.onmicrosoft.com&quot;
$OutputFile = &quot;C:\Reports\OneDriveAdmins.csv&quot;

# Connect to SharePoint Admin Center
Connect-PnPOnline -Url $AdminURL -ClientId $ClientId -Thumbprint $Thumbprint -Tenant $Tenant -ErrorAction Stop

# Get all OneDrive (MySite) sites
$MySites = Get-PnPTenantSite -IncludeOneDriveSites -Filter &quot;Url -like '-my.sharepoint.com/personal/'&quot;

# Initialize results and error logs
$AllAdmins = @()
$ErrorLog = @()

# Process each MySite
foreach ($MySite in $MySites) {
    try {
        Write-Host &quot;Processing: $($MySite.Title)&quot; -ForegroundColor Green

        # Connect to the MySite
        Connect-PnPOnline -Url $MySite.Url -ClientId $ClientId -Thumbprint $Thumbprint -Tenant $Tenant -ErrorAction Stop

        # Get site collection admins
        $Admins = Get-PnPSiteCollectionAdmin -ErrorAction Stop

        foreach ($admin in $Admins) {
            $AllAdmins += [PSCustomObject]@{
                SiteURL                 = $MySite.Url
                SiteName                = $MySite.Title
                SiteCollectionAdmin     = $admin.Email
                SiteCollectionAdminName = $admin.Title
            }
        }
    }
    catch {
        Write-Warning &quot;Error processing site $($MySite.Title): $_&quot;
        $ErrorLog += [PSCustomObject]@{
            SiteURL = $MySite.Url
            SiteName = $MySite.Title
            ErrorMessage = $_.Exception.Message
        }
    }
}

# Export results to CSV
$AllAdmins | Export-Csv -Path $OutputFile -NoTypeInformation -Encoding UTF8

# Export errors if any
if ($ErrorLog.Count -gt 0) {
    $ErrorFile = &quot;C:\Reports\Errors-OneDriveAdmins.csv&quot;
    $ErrorLog | Export-Csv -Path $ErrorFile -NoTypeInformation -Encoding UTF8
    Write-Warning &quot;Errors encountered. See $ErrorFile for details.&quot;
}

Write-Host &quot;Script completed successfully!&quot; -ForegroundColor Green


</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>PnP PowerShell</strong> to learn more at: <a href="https://aka.ms/pnp/powershell">https://aka.ms/pnp/powershell</a></p>
</div>
<div class="highlight-tool">
<p>The way you login into PnP PowerShell has changed please read <a href="https://github.com/pnp/powershell/discussions/4249">PnP Management Shell EntraID app is deleted : what should I do ?</a></p>
</div>
</section>
<section id="tabpanel_1_pnpps" role="tabpanel" data-tab="pnpps" aria-hidden="true" hidden="hidden">

<pre><code class="lang-powershell">
#Parameters
$AdminURL = &quot;https://contoso-admin.sharepoint.com&quot;
$ReportOutput = &quot;OneDriveAdmins.csv&quot;

#Authentication Details - If you have not registered PnP before, simply run the command Register-PnPAzureADApp to create an App
$ClientId = &quot;xxxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxx&quot;
$Thumbprint = &quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;
$Tenant = &quot;contoso.onmicrosoft.com&quot;

#Connect to SharePoint Online Admin site
Connect-PnPOnline $AdminURL -ClientId $ClientId -Thumbprint $Thumbprint  -Tenant $Tenant 

#Get all Mysites
$MySites = Get-PnPTenantSite -IncludeOneDriveSites -Filter &quot;Url -like '-my.sharepoint.com/personal/'&quot;

foreach ($MySite in $MySites) {
    try{
        write-host &quot;Processing&quot;$Mysite.Title -ForegroundColor Green
        #Connect to the MySite
        Connect-PnPOnline $MySite.Url -ClientId $ClientId -Thumbprint $Thumbprint  -Tenant $Tenant -ErrorAction Stop
        #Get the admins
        $Admins = Get-PnPSiteCollectionAdmin -ErrorAction Stop
        
        foreach($admin in $Admins){
            #Foreach admin make a record to output to CSV   
            $Result = New-Object PSObject -Property ([ordered]@{
                SiteURL = $Mysite.Url
                SiteName = $Mysite.Title
                SiteCollectionAdmin = $admin.Email
                SiteCollectionAdminName = $admin.Title
            })
            
            #Export the results to CSV
            $Result | Export-Csv -Path $ReportOutput -NoTypeInformation -Append

        }
    }catch{
        #We encountered an error, print it to the screen
        write-host &quot;Error with site collection&quot;$Mysite.Title -ForegroundColor Red
    }
}

</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>PnP PowerShell</strong> to learn more at: <a href="https://aka.ms/pnp/powershell">https://aka.ms/pnp/powershell</a></p>
</div>
<div class="highlight-tool">
<p>The way you login into PnP PowerShell has changed please read <a href="https://github.com/pnp/powershell/discussions/4249">PnP Management Shell EntraID app is deleted : what should I do ?</a></p>
</div>
</section>
</div>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Matt Maher</td>
</tr>
<tr>
<td><a href="https://github.com/ojopiyo">Josiah Opiyo</a></td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/onedrive-export-admins" aria-hidden="true">

</article>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
      
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>

    <script type="text/javascript" src="../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>

    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>