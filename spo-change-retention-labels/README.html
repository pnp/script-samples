<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>M365 Consultant&#39;s Script Kit | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="M365 Consultant&#39;s Script Kit | PnP Samples ">
    <meta name="generator" content="docfx ">
  <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">

    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="M365 Consultant&#39;s Script Kit | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
  <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">

    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.min.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
  
  
  <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/spo-change-retention-labels/README.md/#L1" title="Edit this page" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
  <h1 id="m365-consultants-script-kit">M365 Consultant's Script Kit</h1>

<h2 id="summary">Summary</h2>
<p>This scripts is part of the Microsoft 365 Consultant's Script kit, created by Nick Brattoli and Three Six Five Consulting.</p>
<p>It will scan every SharePoint site (or OneDrive URL) and look at every item. When it does this, it will check the retention label for said item. If the retention label matches the hardcoded value, the label will be set to a new one.</p>
<p>The reason for this script is because you cannot change certain actions in retention labels without making a new one, and there is no easy way to switch many items at once. Note that you may need to mess with pagination if you have a large amount of items.</p>
<h2 id="pre-requisites">Pre-requisites</h2>
<pre><code>PowerShell 7 must be installed

The following PowerShell modules are needed:
PnP.PowerShell
</code></pre>
<h2 id="setup">Setup</h2>
<h3 id="prepare-the-csv-file-with-sharepoint-site-urls">Prepare the CSV file with SharePoint site URLs:</h3>
<ol>
<li>Use the included URLStoScan csv file</li>
<li>Place the urls in the csv file</li>
</ol>
<h3 id="edit-the-script">Edit the script:</h3>
<ol>
<li>Open the script file in a text editor (or Visual Studio Code).</li>
<li>Modify the variable $CsvFilePath to specify the path to the CSV file you are using if necessary</li>
</ol>
<h4 id="customize-retention-label-updates">Customize retention label updates:</h4>
<ol>
<li>Review the if and elseif statements within the script.</li>
<li>change the first two &quot;if/else&quot; statements to include the your old and new labels</li>
<li>If you have more than two, uncomment and modify the sections related to retention labels that you want to update based on your specific requirements.
For example, if you want to update the &quot;25 years&quot; retention label, uncomment the section and modify it as follows:</li>
</ol>
<p>elseif ($ExistingRetentionLabel -eq &quot;25 years&quot;) {
Set-PnPListItem -List $List -Identity $Item.Id -Values @{ &quot;_ComplianceTag&quot; = &quot;New 25 Years Label&quot; }
}</p>
<p><img src="assets/retentionlabels.png" alt="Setup your labels"></p>
<ol start="4">
<li>Save the modified script:</li>
</ol>
<h2 id="running-the-script">Running the Script</h2>
<p>Now that the scripts are setup, you just need to run them. All these steps are the same, just change the name of the script.</p>
<ol>
<li>Open PowerShell 7 (as administrator recommended)</li>
<li>Type CD “<whatever the path is where these scripts are>”</whatever></li>
<li>Run the Script</li>
</ol>
<div class="tabGroup" id="tabgroup_1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_1_pnpps" role="tab" aria-controls="tabpanel_1_pnpps" data-tab="pnpps" tabindex="0" aria-selected="true">PnP PowerShell</a>
</li>
</ul>
<section id="tabpanel_1_pnpps" role="tabpanel" data-tab="pnpps">

<pre><code class="lang-powershell">
Start-Transcript -Append log.txt
# Import PnP PowerShell module
Import-Module -Name pnp.powershell -DisableNameChecking


# Read SharePoint site URLs from CSV file
$CsvFilePath = &quot;&lt;PATH&gt;\URLStoScan.csv&quot;
$SiteUrls = Import-Csv -Path $CsvFilePath | Select-Object -ExpandProperty SiteUrl

# Define retention label mapping
$RetentionLabelMapping = @{
    &quot;Script Test 1 Old&quot; = &quot;Script Test 1 New&quot;
    &quot;Script Test 2 Old&quot; = &quot;Script Test 2 New&quot;
    #&quot;25 years&quot;          = &quot;New 25 Years Label&quot;
    #&quot;30 years&quot;          = &quot;New 30 Years Label&quot;
    #&quot;35 years&quot;          = &quot;New 35 Years Label&quot;
}

# Function to process a single list item
function Set-RetentionLabel {
    param (
        [Parameter(Mandatory)]
        $List,

        [Parameter(Mandatory)]
        $Item,

        [Parameter(Mandatory)]
        $FieldInternalName,

        [Parameter(Mandatory)]
        $Mapping
    )

    $CurrentLabel = $Item[$FieldInternalName]
    Write-Host &quot;Item ID: $($Item.Id) | Current label: $CurrentLabel&quot; -ForegroundColor Blue

    if ($Mapping.ContainsKey($CurrentLabel)) {
        $NewLabel = $Mapping[$CurrentLabel]
        Set-PnPListItem -List $List -Identity $Item.Id -Label $NewLabel
        Write-Host &quot;Updated label to: $NewLabel&quot; -ForegroundColor Green
    } else {
        Write-Host &quot;No matching retention label found for Item ID $($Item.Id) in List '$($List.Title)'&quot; -ForegroundColor Yellow
    }
}

# Iterate through each SharePoint site
foreach ($SiteUrl in $SiteUrls) {
    Write-Host &quot;Processing SharePoint site: $SiteUrl&quot; -ForegroundColor Cyan

    Connect-PnPOnline -Url $SiteUrl -Interactive

    # Retrieve all lists and libraries
    $Lists = Get-PnPList | Where-Object { $_.BaseType -in @(&quot;GenericList&quot;,&quot;DocumentLibrary&quot;) }
    Write-Host &quot;$($Lists.Count) lists/libraries retrieved.&quot; -ForegroundColor Green

    foreach ($List in $Lists) {
        Write-Host &quot;Processing list: $($List.Title)&quot; -ForegroundColor Cyan

        # Get retention label field
        $RetentionField = Get-PnPField -List $List -Identity &quot;_ComplianceTag&quot;
        if (-not $RetentionField) {
            Write-Host &quot;Retention label field not found in list $($List.Title).&quot; -ForegroundColor Red
            continue
        }

        # Retrieve all items
        $Items = Get-PnPListItem -List $List
        Write-Host &quot;$($Items.Count) items found in list $($List.Title).&quot; -ForegroundColor Yellow

        foreach ($Item in $Items) {
            Set-RetentionLabel -List $List -Item $Item -FieldInternalName $RetentionField.InternalName -Mapping $RetentionLabelMapping
        }

        Write-Host &quot;Finished processing list $($List.Title).&quot; -ForegroundColor Green
    }

    Write-Host &quot;Finished processing site $SiteUrl.&quot; -ForegroundColor Cyan
}

Stop-Transcript

</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>PnP PowerShell</strong> to learn more at: <a href="https://aka.ms/pnp/powershell">https://aka.ms/pnp/powershell</a></p>
</div>
<div class="highlight-tool">
<p>The way you login into PnP PowerShell has changed please read <a href="https://github.com/pnp/powershell/discussions/4249">PnP Management Shell EntraID app is deleted : what should I do ?</a></p>
</div>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Nick Brattoli</td>
</tr>
<tr>
<td><a href="https://github.com/ojopiyo">Josiah Opiyo</a></td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/spo-change-retention-labels" aria-hidden="true">
</section>
</div>

</article>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
      
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>

    <script type="text/javascript" src="../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>

    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>