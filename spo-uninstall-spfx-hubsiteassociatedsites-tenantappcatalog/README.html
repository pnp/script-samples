<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <title>Retracting SPFx Solutions from Hub Site and associated sites | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" "="">
    <meta name="title" content="Retracting SPFx Solutions from Hub Site and associated sites | PnP Samples ">
    <meta name="generator" content="docfx 2.56.7.0">
    <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Retracting SPFx Solutions from Hub Site and associated sites | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
    <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>    </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/spo-uninstall-spfx-hubsiteassociatedsites-tenantappcatalog/README.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="retracting-spfx-solutions-from-hub-site-and-associated-sites">Retracting SPFx Solutions from Hub Site and associated sites</h1>

<h2 id="summary">Summary</h2>
<p>At the time of submitting this script sample there is no concept of a hub site app catalog. However you may want to install or upgrade or uninstall a SPFx solution to all sites within a hub for example all sites linked to the intranet hub.  There is a script that covers deploying SPFx across all sites in a hub using the tenant app catalog. <a href="../spo-deploy-install-update-spfx-hubsiteassociatedsites-tenantappcatalog/README.html">Deploys and Installs SharePoint Framework (SPFx) solutions to Hub Site and Associated Sites using the tenant app catalog</a>. This sample covers how to uninstall SPFx package across hub site and associated sites from the tenant app catalogue.</p>
<p><img src="assets/example.png" alt="Example Screenshot"></p>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li><p>The user account that runs the script must have SharePoint Online tenant administrator access.</p>
</li>
<li><p>Before running the script, edit the script and update the variable values in the Config Variables section, such as Admin Center URL, Hub Site URL, the CSV output file path and alternatively the sppkg packages Folder.</p>
</li>
</ul>
<p>This script snippet automates the removal of SPFx packages across associated sites of a hub site, leveraging the tenant-level app catalog. It navigates through each associated site, checks for existing packages and uninstalls them.</p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_pnpps" role="tab" aria-controls="tabpanel_CeZOj-G++Q_pnpps" data-tab="pnpps" tabindex="0" aria-selected="true">PnP PowerShell</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_pnpps" role="tabpanel" data-tab="pnpps">

<pre><code class="lang-powershell">$AdminCenterURL=&quot;https://contoso-admin.sharepoint.com&quot;
$tenantAppCatalogUrl = &quot;https://contoso.sharepoint.com/sites/apps&quot;
$hubSiteUrl = &quot;https://contoso.sharepoint.com/sites/Contosoinc-intranet&quot;
$dateTime = (Get-Date).toString(&quot;dd-MM-yyyy&quot;)
$invocation = (Get-Variable MyInvocation).Value
$directorypath = Split-Path $invocation.MyCommand.Path
$fileName = &quot;\Log_Tenant_Removing_Solution&quot; + $dateTime + &quot;.csv&quot;
$OutPutView = $directorypath + $fileName
 
$sppkgFolder = &quot;./packages&quot;
 
cd $PSScriptRoot
$packageFiles = Get-ChildItem $sppkgFolder
 
Connect-PnPOnline $tenantAppCatalogUrl -Interactive
$appCatConnection  = Get-PnPConnection
 
Connect-PnPOnline $AdminCenterURL -Interactive
$adminConnection  = Get-PnPConnection
 
$SiteAppUpdateCollection = @()

$associatedSites = Get-PnPHubSiteChild -Identity $hubSiteUrl -Connection $adminConnection
$associatedSites += $hubSiteUrl #Add the hub site to the list of associated sites
#Get all site collections associated with the hub site
$associatedSites | ForEach-Object {
    $Site = Get-PnPTenantSite $_ -Connection $adminConnection
     Connect-PnPOnline -Url $Site.url -Interactive
     $siteConnection  = Get-PnPConnection
       foreach($package in $packageFiles)
       {
          $packageName = $package.PSChildName    
           #Find Name of app from installed package
           $RestMethodUrl = '/_api/web/lists/getbytitle(''Apps%20for%20SharePoint'')/items?$select=Title,LinkFilename'
           $apps = (Invoke-PnPSPRestMethod -Url $RestMethodUrl -Method Get -Connection $appCatConnection).Value
           $appTitle = ($apps | where-object {$_.LinkFilename -eq $packageName} | Select-Object Title).Title
        
           $currentPackage = Get-PnPApp -Identity $appTitle -scope Tenant
#check is app is installed on site
           $web = Get-PnPWeb -Includes AppTiles -Connection $siteConnection
           $app = $web.AppTiles  |  where-object {$_.Title -eq $currentPackage.Title }
        if($app)
        {
          Write-Host &quot;Removing packages $packageName from $($Site.url)&quot; -ForegroundColor Yellow     
          Uninstall-PnPApp -Identity $currentPackage.Id -Connection $siteConnection
            $ExportVw = New-Object PSObject
            $ExportVw | Add-Member -MemberType NoteProperty -name &quot;Site URL&quot; -value $Site.url  
            $ExportVw | Add-Member -MemberType NoteProperty -name &quot;Package Name&quot; -value $packageName
        }
        $SiteAppUpdateCollection += $ExportVw     
      }     
  }

foreach($package in $packageFiles)
{
  $packageName = $package.PSChildName
   Write-Host &quot;Removing $packageName from tenant&quot; -ForegroundColor Yellow
   $RestMethodUrl = '/_api/web/lists/getbytitle(''Apps%20for%20SharePoint'')/items?$select=Title,LinkFilename'
   $apps = (Invoke-PnPSPRestMethod -Url $RestMethodUrl -Method Get -Connection $appCatConnection).Value
   $appTitle = ($apps | where-object {$_.LinkFilename -eq $packageName} | select Title).Title
   Remove-PnPApp -Identity $appTitle -Scope Tenant
}
#Export the result Array to CSV file
$SiteAppUpdateCollection | Export-CSV $OutPutView -Force -NoTypeInformation
 
Disconnect-PnPOnline
</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>SharePoint admin rights are required to run the script</p>
</div>
<div class="highlight-tool">
<p>Check out the <strong>PnP PowerShell</strong> to learn more at: <a href="https://aka.ms/pnp/powershell">https://aka.ms/pnp/powershell</a></p>
</div>
<div class="highlight-tool">
<p>The way you login into PnP PowerShell has changed please read <a href="https://github.com/pnp/powershell/discussions/4249">PnP Management Shell EntraID app is deleted : what should I do ?</a></p>
</div>
</section>
</div>
<h2 id="source-credit">Source Credit</h2>
<p>Sample first appeared on <a href="https://reshmeeauckloo.com/posts/powershell-retract-spfx-from-sites-tenant/">Retracting SPFx Solutions from Tenant Sites using PnP PowerShell</a></p>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/reshmee011">Reshmee Auckloo</a></td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/spo-uninstall-spfx-hubsiteassociatedsites-tenantappcatalog" aria-hidden="true">
</article>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    
    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>