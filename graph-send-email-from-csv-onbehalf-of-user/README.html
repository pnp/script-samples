<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Bulk Email Send from CSV using Microsoft Graph API | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="Bulk Email Send from CSV using Microsoft Graph API | PnP Samples ">
    <meta name="generator" content="docfx ">
  <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">

    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Bulk Email Send from CSV using Microsoft Graph API | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
  <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">

    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.min.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
  
  
  <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/graph-send-email-from-csv-onbehalf-of-user/README.md/#L1" title="Edit this page" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
  <h1 id="bulk-email-send-from-csv-using-microsoft-graph-api">Bulk Email Send from CSV using Microsoft Graph API</h1>

<h2 id="summary">Summary</h2>
<p>This PowerShell script can be used to send bulk emails to multiple users from CSV file....This script is will also work to send email on behalf of user. So you can specify sender of email seperately for each email, it also also supports sending email with attachments.</p>
<h1 id="csv-file-columns-details">CSV file columns details</h1>
<p>Below is table to showcase what all fields are required to add in csv and its details.</p>
<table>
<thead>
<tr>
<th>Column Name</th>
<th>Details</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sender</td>
<td>The email sender</td>
<td>This can be any email id of your own or any other user's email id</td>
</tr>
<tr>
<td>Receiver</td>
<td>Recipient email addresses</td>
<td>You can specify multiple email ids here separated with comma (,)</td>
</tr>
<tr>
<td>CC</td>
<td>CC email addresses</td>
<td>You can specify multiple email ids here separated with comma (,)</td>
</tr>
<tr>
<td>BCC</td>
<td>BCC email addresses</td>
<td>You can specify multiple email ids here separated with comma (,)</td>
</tr>
<tr>
<td>Subject</td>
<td>Subject of email</td>
<td></td>
</tr>
<tr>
<td>Body</td>
<td>Email body content</td>
<td>this can be plain text or HTML, this also supports inline images in base 64 format</td>
</tr>
<tr>
<td>AttachmentFile</td>
<td>path of attachment</td>
<td>specify full file path here</td>
</tr>
</tbody>
</table>
<p>You can download input reference file at <a href="assets/EmailDetails.csv">here</a>.</p>
<p>Please keep file in the same location as script.
Also the attachments referred in csv should match the file path of your local machine.</p>
<h2 id="permissions">Permissions</h2>
<p>As the script use App Registration Application Permission, please make sure you are have given below permission for the Azure AD App</p>
<p><img src="assets/API_Permissions.png" alt="Permission"></p>
<h2 id="implementation">Implementation</h2>
<ul>
<li>Open Windows PowerShell ISE</li>
<li>Create a new file</li>
<li>Prepare the input csv file based on instruction above</li>
<li>update the path in below script</li>
<li>Save the file and run it</li>
</ul>
<div class="tabGroup" id="tabgroup_1">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_1_graphps" role="tab" aria-controls="tabpanel_1_graphps" data-tab="graphps" tabindex="0" aria-selected="true">Microsoft Graph PowerShell</a>
</li>
</ul>
<section id="tabpanel_1_graphps" role="tabpanel" data-tab="graphps">

<pre><code class="lang-powershell">

#Modules for Power Apps Powershell Commands

	Import-Module Microsoft.PowerShell.Utility
	Import-Module MSAL.PS

	$ClientId = &quot;**************************&quot;
	$ClientSecret = &quot;**************************&quot;
	$tenantID = &quot;**************************&quot;
	$SiteURL = &quot;https://*****.sharepoint.com/sites/****&quot;
	$EmailDetailsFileName = &quot;EmailDetails.csv&quot;
 
		
        ########################### reading CSV to get details about email ###################
        Write-Output(Get-Location)
        $EmailDetails =get-content -Path $PSScriptRoot\$EmailDetailsFileName | Out-String | ConvertFrom-Csv
        Write-Output($EmailDetails)
        ########################## send email logic #####################
 
        
	#force the cmdlet to get a new Access Token
		Clear-MsalTokenCache
        $MsalToken = Get-MsalToken -TenantId $tenantID -ClientId $ClientId -ClientSecret ($ClientSecret | ConvertTo-SecureString -AsPlainText -Force)
        # Create header with the access token

        $headers = New-Object &quot;System.Collections.Generic.Dictionary[[String],[String]]&quot;
        $headers.Add(&quot;Content-Type&quot;, &quot;application/json&quot;)
        $headers.Add(&quot;Authorization&quot;, $MsalToken.CreateAuthorizationHeader())  

	#Send Mail    

        foreach($EmailDetail in $EmailDetails)
        {
            	$URLsend = &quot;https://graph.microsoft.com/v1.0/users/&quot;+$EmailDetail.Sender+&quot;/sendMail&quot;

            	$ListReceiver = $EmailDetail.Receiver.Split(&quot;,&quot;)
            	$ToinJSON =&quot;&quot;
		foreach($receiver in $ListReceiver)
		{
			$ToinJSON = $ToinJSON + ($receiver | %{'{&quot;EmailAddress&quot;: {&quot;Address&quot;: &quot;'+$_+'&quot;}},'})
		}
		$ToinJSON = ([string]$ToinJSON).Substring(0, ([string]$ToinJSON ).Length - 1)
         
		$ListCC = $EmailDetail.CC.Split(&quot;,&quot;)
		$CCinJSON =&quot;&quot;
		foreach($cc in $ListCC)
		{
			$CCinJSON = $CCinJSON + ($cc | %{'{&quot;EmailAddress&quot;: {&quot;Address&quot;: &quot;'+$_+'&quot;}},'})
		}
		$CCinJSON = ([string]$CCinJSON).Substring(0, ([string]$CCinJSON ).Length - 1)

		$ListBCC = $EmailDetail.BCC.Split(&quot;,&quot;)
		$BCCinJSON = &quot;&quot;
		foreach($bcc in $ListBCC)
		{
			$BCCinJSON = $BCCinJSON + ($bcc | %{'{&quot;EmailAddress&quot;: {&quot;Address&quot;: &quot;'+$_+'&quot;}},'})
		}
		$BCCinJSON = ([string]$BCCinJSON).Substring(0, ([string]$BCCinJSON ).Length - 1)

		$BodyJsonsend = &quot;{`&quot;message`&quot;: {`&quot;subject`&quot;: `&quot;&quot; + $EmailDetail.Subject + &quot;`&quot;,`&quot;body`&quot;: {`&quot;contentType`&quot;: `&quot;HTML`&quot;,`&quot;content`&quot;: `&quot;&quot; + $EmailDetail.Body.Replace(&quot;`&quot;&quot;,&quot;\`&quot;&quot;) + &quot;`&quot;}&quot;

		#add below sections, only if Receiver/CC/BCC/Attachment are specified
		if($EmailDetail.Receiver.Length -ge 1)
		{
			$BodyJsonsend += &quot;,`&quot;toRecipients`&quot;: [&quot; + $ToinJSON + &quot;]&quot;
		}
            
            	if($EmailDetail.CC.Length -ge 1)
		{
			$BodyJsonsend += &quot;,`&quot;ccRecipients`&quot;: [&quot; + $CCinJSON + &quot;]&quot;
		}

		if($EmailDetail.BCC.Length -ge 1)
		{
			$BodyJsonsend += &quot;,`&quot;bccRecipients`&quot;: [&quot; + $BCCinJSON + &quot;]&quot;
		}

		if($EmailDetail.AttachmentFile.Length -ge 1)
		{
			$attach = $EmailDetail.AttachmentFile
			$attachFileName = (Get-Item -Path $attach).Name
			$base64string = [Convert]::ToBase64String([IO.File]::ReadAllBytes($attach))
			$BodyJsonsend +=  &quot;,`&quot;attachments`&quot;: [{
			`&quot;@odata.type`&quot;: `&quot;#microsoft.graph.fileAttachment`&quot;
			,`&quot;name`&quot;: `&quot;&quot; + $attachFileName + &quot;`&quot;,`&quot;contentType`&quot;: `&quot;text/plain`&quot;,
			`&quot;contentBytes`&quot;: `&quot;&quot; + $base64string + &quot;`&quot;}]&quot;
		}

		$BodyJsonsend += &quot;}}&quot;
		$response = Invoke-RestMethod -Method POST -Uri $URLsend -Headers $headers -Body $BodyJsonsend 
		$response 
        }
</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>Power Apps PowerShell</strong> to learn more at: <a href="https://learn.microsoft.com/power-platform/admin/powerapps-powershell">https://learn.microsoft.com/power-platform/admin/powerapps-powershell</a></p>
</div>
</section>
</div>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/siddharth-vaghasia">Siddharth Vaghasia</a></td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/graph-send-email-from-csv-onbehalf-of-user" aria-hidden="true">

</article>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
      
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>

    <script type="text/javascript" src="../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>

    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>