<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <title>Get Azure AD (Entra ID) Guest Users with Elevated Permissions (M365) | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="Get Azure AD (Entra ID) Guest Users with Elevated Permissions (M365) | PnP Samples ">
    <meta name="generator" content="docfx 2.56.7.0">
    <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Get Azure AD (Entra ID) Guest Users with Elevated Permissions (M365) | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
    <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>    </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/spo-get-entra-id-guest-users-with-elevated-permissions-m365/README.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="get-azure-ad-entra-id-guest-users-with-elevated-permissions-m365">Get Azure AD (Entra ID) Guest Users with Elevated Permissions (M365)</h1>

<h2 id="summary">Summary</h2>
<p>This script audits and identifies Azure AD (Entra ID) guest (B2B) users who have been granted elevated permissions across Microsoft 365 services, including Entra ID directory roles, Microsoft Teams ownership, and SharePoint Online site collection administration. It generates a consolidated report to support security reviews, least-privilege enforcement, and external access governance.</p>
<h3 id="why-it-matters">Why It Matters</h3>
<ul>
<li><strong>Risk reduction:</strong> Identifies external accounts with elevated access before they become a security issue.</li>
<li><strong>Compliance support:</strong> Provides evidence for audits and regulatory requirements.</li>
<li><strong>Operational efficiency:</strong> Consolidates checks across Entra ID, Teams, and SharePoint into one report.</li>
<li><strong>Governance enforcement:</strong> Helps enforce least‑privilege and external access policies consistently.</li>
</ul>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_pnpps" role="tab" aria-controls="tabpanel_CeZOj-G++Q_pnpps" data-tab="pnpps" tabindex="0" aria-selected="true">PnP PowerShell</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_pnpps" role="tabpanel" data-tab="pnpps">

<pre><code class="lang-powershell">
# ------------------------------------------------------------
# Configuration
# ------------------------------------------------------------
$TenantAdminUrl = &quot;https://contoso-admin.sharepoint.com&quot;
$OutputPath = &quot;C:\Temp\GuestUsersWithExcessivePermissions.csv&quot;

# ------------------------------------------------------------
# Connect
# ------------------------------------------------------------
if (-not $conn) {
    $conn = Connect-PnPOnline -Url $TenantAdminUrl -Interactive -ReturnConnection
}

# ------------------------------------------------------------
# Helper: Get all guest users
# ------------------------------------------------------------
function Get-GuestUsers {
    param([Parameter(Mandatory)] $Connection)

    Invoke-PnPGraphMethod -Url &quot;users?`$filter=userType eq 'Guest'&amp;`$select=id,displayName,userPrincipalName,userType&quot; `
        -Connection $Connection
}

# ------------------------------------------------------------
# Helper: Get Entra ID directory roles for guests
# ------------------------------------------------------------
function Get-GuestDirectoryRoles {
    param(
        [Parameter(Mandatory)] $Connection,
        [Parameter(Mandatory)] $Guests
    )

    $results = @()

    $roles = Invoke-PnPGraphMethod -Url &quot;directoryRoles&quot; -Connection $Connection

    foreach ($role in $roles.value) {
        $members = Invoke-PnPGraphMethod -Url &quot;directoryRoles/$($role.id)/members&quot; -Connection $Connection

        foreach ($member in $members.value) {
            if ($member.userType -eq &quot;Guest&quot;) {
                $results += [PSCustomObject]@{
                    DisplayName        = $member.displayName
                    UserPrincipalName  = $member.userPrincipalName
                    PermissionType     = &quot;AAD Role&quot;
                    AssignedRole       = $role.displayName
                    Resource           = &quot;Tenant&quot;
                }
            }
        }
    }

    return $results
}

# ------------------------------------------------------------
# Helper: Get Teams owned by guests
# ------------------------------------------------------------
function Get-GuestTeamOwners {
    param([Parameter(Mandatory)] $Connection)

    $results = @()
    $groups = Invoke-PnPGraphMethod -Url &quot;groups?`$filter=resourceProvisioningOptions/Any(x:x eq 'Team')&quot; `
        -Connection $Connection

    foreach ($group in $groups.value) {
        $owners = Invoke-PnPGraphMethod -Url &quot;groups/$($group.id)/owners&quot; -Connection $Connection

        foreach ($owner in $owners.value) {
            if ($owner.userType -eq &quot;Guest&quot;) {
                $results += [PSCustomObject]@{
                    DisplayName        = $owner.displayName
                    UserPrincipalName  = $owner.userPrincipalName
                    PermissionType     = &quot;Teams&quot;
                    AssignedRole       = &quot;Owner&quot;
                    Resource           = $group.displayName
                }
            }
        }
    }

    return $results
}

# ------------------------------------------------------------
# Helper: Get SharePoint Site Collection Admins (guests only)
# ------------------------------------------------------------
function Get-GuestSPOAdmins {
    param([Parameter(Mandatory)] $Connection)

    $results = @()
    $sites = Get-PnPTenantSite -Connection $Connection

    foreach ($site in $sites) {
        try {
            Connect-PnPOnline -Url $site.Url -Connection $Connection
            $admins = Get-PnPSiteCollectionAdmin

            foreach ($admin in $admins) {
                if ($admin.PrincipalType -eq &quot;User&quot; -and $admin.LoginName -like &quot;*#EXT#*&quot;) {
                    $results += [PSCustomObject]@{
                        DisplayName        = $admin.Title
                        UserPrincipalName  = $admin.Email
                        PermissionType     = &quot;SharePoint&quot;
                        AssignedRole       = &quot;Site Collection Administrator&quot;
                        Resource           = $site.Url
                    }
                }
            }
        }
        catch {
            Write-Warning &quot;Failed to process site $($site.Url)&quot;
        }
    }

    return $results
}

# ------------------------------------------------------------
# Main Execution
# ------------------------------------------------------------
Write-Host &quot;Retrieving guest users...&quot; -ForegroundColor Cyan
$guestUsers = Get-GuestUsers -Connection $conn

Write-Host &quot;Checking Entra ID directory roles...&quot; -ForegroundColor Cyan
$aadRoles = Get-GuestDirectoryRoles -Connection $conn -Guests $guestUsers.value

Write-Host &quot;Checking Microsoft Teams ownership...&quot; -ForegroundColor Cyan
$teamsOwners = Get-GuestTeamOwners -Connection $conn

Write-Host &quot;Checking SharePoint site collection administrators...&quot; -ForegroundColor Cyan
$spoAdmins = Get-GuestSPOAdmins -Connection $conn

# ------------------------------------------------------------
# Consolidate Results
# ------------------------------------------------------------
$finalResults = @()
$finalResults += $aadRoles
$finalResults += $teamsOwners
$finalResults += $spoAdmins

# ------------------------------------------------------------
# Export
# ------------------------------------------------------------
$finalResults |
    Sort-Object UserPrincipalName, PermissionType |
    Export-Csv -Path $OutputPath -NoTypeInformation -Encoding UTF8

Write-Host &quot;Completed. Results exported to $OutputPath&quot; -ForegroundColor Green

</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>PnP PowerShell</strong> to learn more at: <a href="https://aka.ms/pnp/powershell">https://aka.ms/pnp/powershell</a></p>
</div>
<div class="highlight-tool">
<p>The way you login into PnP PowerShell has changed please read <a href="https://github.com/pnp/powershell/discussions/4249">PnP Management Shell EntraID app is deleted : what should I do ?</a></p>
</div>
</section>
</div>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Josiah Opiyo</td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/aspo-get-entra-id-guest-users-with-elevated-permissions-m365" aria-hidden="true">
</article>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    
    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>