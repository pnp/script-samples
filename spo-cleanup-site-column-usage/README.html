<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <title>Clean Up Unwanted Site Columns from Content Types and Lists/Libraries | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="Clean Up Unwanted Site Columns from Content Types and Lists/Libraries | PnP Samples ">
    <meta name="generator" content="docfx 2.56.7.0">
    <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Clean Up Unwanted Site Columns from Content Types and Lists/Libraries | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
    <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>    </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/spo-cleanup-site-column-usage/README.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="clean-up-unwanted-site-columns-from-content-types-and-listslibraries">Clean Up Unwanted Site Columns from Content Types and Lists/Libraries</h1>

<h2 id="summary">Summary</h2>
<p>Sometimes when we iteratively build out our information architecture, we’re over-zealous. It seems like we need a set of Site Columns to maintain metadata on lists or libraries, but in the end, we decide we want to trim away a few of the Site Columns we’ve created. Or, maybe you’ve migrated a bunch of metadata into SharePoint with a set of documents and it turns out that metadata is no longer valid or useful.</p>
<p>If the Site Columns exist in only one or two libraries, it’s not a big deal to do this manually. But when you need to remove several Site Columns across a dozen or so Content Types, which are applied to a dozen or so libraries, PowerShell may make more sense.</p>
<p>When we want to clean up use of a Site Column – and we’re setting up our information architecture well – there are three main steps:</p>
<ul>
<li>Remove the Site Column from all Content Types which have it.</li>
<li>Remove the orphaned Site Column from all lists/libraries which have it. When we remove a Site Column from Content Types which are enabled on lists or libraries, the orphaned Site Column remains. This makes sense, because you probably have some data in that column. To truly remove it, you need to remove the column in each list as well.</li>
<li>Remove the Site Column itself. This removes it from the site entirely.</li>
</ul>
<h2 id="reportonly--true">$reportOnly = $true</h2>
<p><img src="assets/report-only-true.jpg" alt="$reportOnly = $true"></p>
<h2 id="reportonly--false">$reportOnly = $false</h2>
<p><img src="assets/report-only-false.jpg" alt="$reportOnly = $false"></p>
<hr>
<p>CLI version of the script works the same except the user needs to provide a list of content types that needs to be checked.</p>
<h2 id="reportonly--true-1">$reportOnly = $true</h2>
<p><img src="assets/cli-report-only-true.png" alt="$reportOnly = $true"></p>
<h2 id="reportonly--false-1">$reportOnly = $false</h2>
<p><img src="assets/cli-report-only-false.png" alt="$reportOnly = $false"></p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_pnp-ps" role="tab" aria-controls="tabpanel_CeZOj-G++Q_pnp-ps" data-tab="pnp-ps" tabindex="0" aria-selected="true">PnP.PowerShell</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_cli-m365-ps" role="tab" aria-controls="tabpanel_CeZOj-G++Q_cli-m365-ps" data-tab="cli-m365-ps" tabindex="-1">CLI for Microsoft 365</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_pnp-ps" role="tabpanel" data-tab="pnp-ps">

<pre><code class="lang-powershell"># Import modules
Import-Module PnP.PowerShell

# Base variables
$siteURL = &quot;https://tenant.sharepoint.com/sites/sitename&quot;
$siteColumn = &quot;EffectiveDate&quot;
$reportOnly = $false # If $true, just report. If $false, take action.

# Connect to the tenant
$siteConnection = Connect-PnPOnline -Url $siteUrl -Interactive -ReturnConnection

# Remove the Site Column from all Content Types which have it
Write-Host -BackgroundColor Blue &quot;Checking Content Types&quot;

# Get all the Content Types. Here, I have all my custom Content Types in a Group called _ClientName.
$cts = Get-PnPContentType -Connection $siteConnection | Where-Object { $_.Group -eq &quot;_ClientName&quot; }

foreach ($ct in $cts) {

    Write-Host &quot;Checking Content Type $($ct.Name)&quot;

    $fields = Get-PnPProperty -ClientObject $ct -property &quot;Fields&quot; | Where-Object { $_.InternalName -eq $siteColumn }
    $field = $fields | Where-Object { $_.InternalName -eq $siteColumn }

    if ($field) {
        Write-Host -ForegroundColor Green &quot;Found column $($siteColumn) in $($ct.Name)&quot;
        if (!$reportOnly) {
            Write-Host -ForegroundColor Yellow &quot;Removing column $($siteColumn) in $($ct.Name)&quot;
            Remove-PnPFieldFromContentType -Field $field -ContentType $ct -Connection $siteConnection
        }
    }

}

# Remove the orphaned Site Column from all lists/libraries which have it
Write-Host -BackgroundColor Blue &quot;Checking Lists&quot;

# Get all lists/libraries in the site, but exclude System or Hidden lists
$lists = Get-PnPList -Connection $siteConnection | Where-Object { $_.Hidden -ne $true -and $_.IsSystemList -ne $true }

foreach ($list in $lists) {

    Write-Host &quot;Checking list $($list.Title)&quot;

    $field = Get-PnPField -List $list | Where-Object { $_.InternalName -eq $siteColumn }

    if ($field) {
        Write-Host -ForegroundColor Green &quot;Found column $($siteColumn) in $($list.Title)&quot;

        if (!$reportOnly) {
            Write-Host -ForegroundColor Yellow &quot;Removing column $($siteColumn) in $($list.Title)&quot;
            Remove-PnPField -Identity $field -List $list -Connection $siteConnection -Force
        }

    }

}

# Remove the Site Column itself
if (!$reportOnly) {
    Remove-PnPField -Identity $siteColumn
}
</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>PnP PowerShell</strong> to learn more at: <a href="https://aka.ms/pnp/powershell">https://aka.ms/pnp/powershell</a></p>
</div>
<div class="highlight-tool">
<p>The way you login into PnP PowerShell has changed please read <a href="https://github.com/pnp/powershell/discussions/4249">PnP Management Shell EntraID app is deleted : what should I do ?</a></p>
</div>
</section>
<section id="tabpanel_CeZOj-G++Q_cli-m365-ps" role="tabpanel" data-tab="cli-m365-ps" aria-hidden="true" hidden="hidden">

<pre><code class="lang-powershell">function Invoke-SiteColumnCleanup {
    [CmdletBinding(SupportsShouldProcess)]
    param(
        [Parameter(Mandatory, HelpMessage = &quot;SharePoint site URL hosting the content types and lists&quot;)]
        [ValidateNotNullOrEmpty()][string] $SiteUrl,

        [Parameter(Mandatory, HelpMessage = &quot;Names of content types that should be scanned for the site column&quot;)]
        [ValidateNotNullOrEmpty()][string[]] $ContentTypeNames,

        [Parameter(Mandatory, HelpMessage = &quot;Display name of the site column to remove&quot;)]
        [ValidateNotNullOrEmpty()][string] $SiteColumnName,

        [Parameter(HelpMessage = &quot;When set, only report usage without removing the column&quot;)]
        [switch] $ReportOnly
    )

    begin {
        Write-Verbose &quot;Ensuring CLI session is authenticated.&quot;
        $loginOutput = m365 login --ensure 2&gt;&amp;1
        if ($LASTEXITCODE -ne 0) {
            throw &quot;Failed to ensure CLI login. CLI output: $loginOutput&quot;
        }

        $script:Summary = [ordered]@{
            ContentTypesChecked   = 0
            ContentTypesUpdated   = 0
            ListsChecked          = 0
            ListsUpdated          = 0
            SiteColumnRemoved     = 0
            Failures              = 0
        }
    }

    process {
        Write-Host &quot;Checking content types for column '$SiteColumnName'.&quot;

        foreach ($ctName in $ContentTypeNames) {
            $script:Summary.ContentTypesChecked++
            Write-Host &quot;Examining content type '$ctName'.&quot;

            $ctOutput = m365 spo contenttype get --webUrl $SiteUrl --name $ctName --output json 2&gt;&amp;1
            if ($LASTEXITCODE -ne 0) {
                $script:Summary.Failures++
                Write-Warning &quot;Failed to retrieve content type '$ctName'. CLI output: $ctOutput&quot;
                continue
            }

            try {
                $ct = $ctOutput | ConvertFrom-Json -ErrorAction Stop
            }
            catch {
                $script:Summary.Failures++
                Write-Warning &quot;Unable to parse content type '$ctName'. $($_.Exception.Message)&quot;
                continue
            }

            $query = &quot;[?Title=='$SiteColumnName' || InternalName=='$SiteColumnName']&quot;
            $fieldsOutput = m365 spo contenttype field list --webUrl $SiteUrl --contentTypeName $ctName --properties &quot;Title,Id,InternalName&quot; --query $query --output json 2&gt;&amp;1
            if ($LASTEXITCODE -ne 0) {
                $script:Summary.Failures++
                Write-Warning &quot;Failed to list fields for content type '$ctName'. CLI output: $fieldsOutput&quot;
                continue
            }

            try {
                $ctFields = $fieldsOutput | ConvertFrom-Json -ErrorAction Stop
            }
            catch {
                $script:Summary.Failures++
                Write-Warning &quot;Unable to parse field list for '$ctName'. $($_.Exception.Message)&quot;
                continue
            }

            $fieldLink = $ctFields | Select-Object -First 1
            if ($fieldLink) {
                Write-Host -ForegroundColor Green &quot;Found field '$SiteColumnName' in content type '$ctName'.&quot;
                if (-not $ReportOnly -and $PSCmdlet.ShouldProcess(&quot;Content type '$ctName'&quot;, &quot;Remove field link&quot;)) {
                    $removeOutput = m365 spo contenttype field remove --webUrl $SiteUrl --contentTypeId $ct.Id.StringValue --id $fieldLink.Id --force 2&gt;&amp;1
                    if ($LASTEXITCODE -ne 0) {
                        $script:Summary.Failures++
                        Write-Warning &quot;Failed to remove field '$SiteColumnName' from '$ctName'. CLI output: $removeOutput&quot;
                    }
                    else {
                        $script:Summary.ContentTypesUpdated++
                    }
                }
            }
        }

        Write-Host &quot;Checking lists for orphaned column '$SiteColumnName'.&quot;
        $listOutput = m365 spo list list --webUrl $SiteUrl --output json 2&gt;&amp;1
        if ($LASTEXITCODE -ne 0) {
            $script:Summary.Failures++
            throw &quot;Failed to retrieve lists. CLI output: $listOutput&quot;
        }

        try {
            $lists = $listOutput | ConvertFrom-Json -ErrorAction Stop
        }
        catch {
            throw &quot;Unable to parse lists response. $($_.Exception.Message)&quot;
        }

        foreach ($list in $lists) {
            $script:Summary.ListsChecked++
            $listTitle = $list.Title
            Write-Host &quot;Examining list '$listTitle'.&quot;

            $listQuery = &quot;[?Title=='$SiteColumnName' || InternalName=='$SiteColumnName']&quot;
            $listFieldsOutput = m365 spo field list --webUrl $SiteUrl --listTitle $listTitle --query $listQuery --output json 2&gt;&amp;1
            if ($LASTEXITCODE -ne 0) {
                $script:Summary.Failures++
                Write-Warning &quot;Failed to list fields for list '$listTitle'. CLI output: $listFieldsOutput&quot;
                continue
            }

            try {
                $listFields = $listFieldsOutput | ConvertFrom-Json -ErrorAction Stop
            }
            catch {
                $script:Summary.Failures++
                Write-Warning &quot;Unable to parse field list for '$listTitle'. $($_.Exception.Message)&quot;
                continue
            }

            $listField = $listFields | Select-Object -First 1
            if (-not $listField) {
                continue
            }

            Write-Host -ForegroundColor Green &quot;Found field '$SiteColumnName' in list '$listTitle'.&quot;
            if (-not $ReportOnly -and $PSCmdlet.ShouldProcess(&quot;List '$listTitle'&quot;, &quot;Remove field&quot;)) {
                $removeFieldOutput = m365 spo field remove --webUrl $SiteUrl --listTitle $listTitle --id $listField.Id --force 2&gt;&amp;1
                if ($LASTEXITCODE -ne 0) {
                    $script:Summary.Failures++
                    Write-Warning &quot;Failed to remove field from list '$listTitle'. CLI output: $removeFieldOutput&quot;
                }
                else {
                    $script:Summary.ListsUpdated++
                }
            }
        }

        if (-not $ReportOnly -and $PSCmdlet.ShouldProcess(&quot;Site '$SiteUrl'&quot;, &quot;Remove site column '$SiteColumnName'&quot;)) {
            $siteFieldOutput = m365 spo field get --webUrl $SiteUrl --title $SiteColumnName --output json 2&gt;&amp;1
            if ($LASTEXITCODE -eq 0) {
                try {
                    $siteField = $siteFieldOutput | ConvertFrom-Json -ErrorAction Stop
                }
                catch {
                    $script:Summary.Failures++
                    throw &quot;Unable to parse site column details for '$SiteColumnName'. $($_.Exception.Message)&quot;
                }

                $removeSiteField = m365 spo field remove --webUrl $SiteUrl --id $siteField.Id --force 2&gt;&amp;1
                if ($LASTEXITCODE -ne 0) {
                    $script:Summary.Failures++
                    Write-Warning &quot;Failed to remove site column '$SiteColumnName'. CLI output: $removeSiteField&quot;
                }
                else {
                    $script:Summary.SiteColumnRemoved++
                }
            }
            else {
                Write-Verbose &quot;Site column '$SiteColumnName' was not found at the site level.&quot;
            }
        }
    }

    end {
        Write-Host &quot;`nCleanup summary:&quot; -ForegroundColor Cyan
        Write-Host &quot;  Content types checked : $($script:Summary.ContentTypesChecked)&quot;
        Write-Host &quot;  Content types updated : $($script:Summary.ContentTypesUpdated)&quot;
        Write-Host &quot;  Lists checked         : $($script:Summary.ListsChecked)&quot;
        Write-Host &quot;  Lists updated         : $($script:Summary.ListsUpdated)&quot;
        Write-Host &quot;  Site columns removed  : $($script:Summary.SiteColumnRemoved)&quot;
        Write-Host &quot;  Failures              : $($script:Summary.Failures)&quot;
    }
}

# Example usage:
# Invoke-SiteColumnCleanup -SiteUrl &quot;https://tenant.sharepoint.com/sites/sitename&quot; -ContentTypeNames 'testCT1','CustomContentType1' -SiteColumnName 'EffectiveDate' -ReportOnly

Invoke-SiteColumnCleanup -SiteUrl &quot;https://tenanttocheck.sharepoint.com/sites/PnPDemo2&quot; -ContentTypeNames 'testContentTypeA','testContentTypeB','testContentTypeC' -SiteColumnName 'testColumn1' -ReportOnly
</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>CLI for Microsoft 365</strong> to learn more at: <a href="https://aka.ms/cli-m365">https://aka.ms/cli-m365</a></p>
</div>
<div class="highlight-tool-red">
<p>Important changes coming to the way you login into CLI for Microsoft 365 (effective 9th September 2024) see <a href="https://pnp.github.io/blog/post/changes-pnp-management-shell-registration/">Changes in PnP Management Shell registration in Microsoft 365</a></p>
</div>
</section>
</div>
<h2 id="source-credit">Source Credit</h2>
<p>Sample first appeared on <a href="https://sympmarc.com/2021/10/14/clean-up-unwanted-site-columns-from-content-types-and-lists-libraries/">Clean Up Unwanted Site Columns from Content Types and Lists/Libraries | Marc D Anderson''s Blog</a></p>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Marc D Anderson</td>
</tr>
<tr>
<td>Adam Wójcik</td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/spo-copy-files-to-another-library" aria-hidden="true">
</article>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    
    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>