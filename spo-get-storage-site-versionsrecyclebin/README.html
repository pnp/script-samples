<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <title>Get Storage site version Recycle Bin | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="Get Storage site version Recycle Bin | PnP Samples ">
    <meta name="generator" content="docfx 2.56.7.0">
    <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Get Storage site version Recycle Bin | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
    <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>    </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/spo-get-storage-site-versionsrecyclebin/README.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="get-storage-site-version-recycle-bin">Get Storage site version Recycle Bin</h1>

<h2 id="summary">Summary</h2>
<p>This sample script may help to get a breakdown of storage for files, file versions and recycle bin. I failed to reconcile the site current usage with the total of file size, total file version size and recycle bin size but may help to get insights on storage usage despite I could not explain 30% of storage allocated. In the sample output, a total of around 15 MB was identified to be comprised of total file size, total version size and recycle bin size and could not identify the remaining 6MB.</p>
<h2 id="implementation">Implementation</h2>
<ul>
<li>Open Windows PowerShell ISE</li>
<li>Create a new file</li>
<li>Write a script as below</li>
<li>Update the $OutputSite, $OutPutFile and optionally update $ExcludedLibraries to exclude any libraries</li>
</ul>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_pnpps" role="tab" aria-controls="tabpanel_CeZOj-G++Q_pnpps" data-tab="pnpps" tabindex="0" aria-selected="true">PnP PowerShell</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_pnpps" role="tabpanel" data-tab="pnpps">

<pre><code class="lang-powershell">
$SharePointAdminSiteURL = &quot;https://contoso-admin.sharepoint.com&quot;
$conn = Connect-PnPOnline -Url $SharePointAdminSiteURL -Interactive

# Set Variables
$dateTime = (Get-Date).toString(&quot;dd-MM-yyyy&quot;)
$invocation = (Get-Variable MyInvocation).Value
$directorypath = Split-Path $invocation.MyCommand.Path
$fileName = &quot;\SiteStoragReport-&quot; + $dateTime + &quot;.csv&quot;
$OutputSite = $directorypath + $fileName
$fileName = &quot;\FileStorageReport-&quot; + $dateTime + &quot;.csv&quot;
$OutPutFile = $directorypath + $fileName

$arraySite = New-Object System.Collections.ArrayList
$arrayFile = New-Object System.Collections.ArrayList

#Exclude certain libraries
#$ExcludedLibraries = @(&quot;Form Templates&quot;, &quot;Preservation Hold Library&quot;, &quot;Site Assets&quot;, &quot;Site Pages&quot;, &quot;Images&quot;, &quot;Pages&quot;, &quot;Settings&quot;, &quot;Videos&quot;, &quot;Site Collection Documents&quot;, &quot;Site Collection Images&quot;, &quot;Style Library&quot;, &quot;AppPages&quot;, &quot;Apps for SharePoint&quot;, &quot;Apps for Office&quot;)

function ReportStorageVersions($site) {
    try {
        $fileSizes = @(); 
        $fileSize = 0 
        $TotalVersionSize = 0
        $DocLibraries = Get-PnPList -Includes BaseType, Hidden, Title -Connection $siteconn | Where-Object { $_.BaseType -eq &quot;DocumentLibrary&quot; -and $_.Hidden -eq $False -and $_.Title -notin $ExcludedLibraries }
        $DocLibraries | ForEach-Object {
            Write-host &quot;Processing Document Library:&quot; $_.Title -f Yellow
            $library = $_
            $listItems = Get-PnPListItem -List $library.Title -Fields &quot;ID&quot; -PageSize 1000 -Connection $siteconn

            #Get file zize
            $listItems | ForEach-Object {
                $listitem = $_
                $fileVersionSize = 0
                $file = Get-PnPFile -Url $listitem[&quot;FileRef&quot;] -AsFileObject -ErrorAction SilentlyContinue -Connection $siteconn 

                if ($file) {
                    $fileSize += $file.Length          
                    $elementFile = &quot;&quot; | Select-Object SiteUrl, siteName, siteStorage, FileRef,FileSize,TotalVersionSize,VersionCount,StartTime, EndTime
                    $elementFile.SiteUrl = $site.Url
                    $elementFile.siteName = $site.Title
                    $elementFile.siteStorage = &quot;$siteStorage MB&quot;
                    $elementFile.StartTime = (Get-Date).toString(&quot;dd-MM-yyyy HH:mm:ss&quot;)
                    $elementFile.FileRef  =   $listitem[&quot;FileRef&quot;]
                    $fileversions = Get-PnPFileVersion -Url $listitem[&quot;FileRef&quot;] -Connection $siteconn
                    if ($fileversions) {
                        # Calculate the total version size
                        $fileVersionSize = $fileversions | Measure-Object -Property Size -Sum | Select-Object -ExpandProperty Sum                                                   
                    }

                    $elementFile.FileSize = &quot;$([Math]::Round(($file.Length/1MB),3)) MB&quot; 
                    $elementFile.TotalVersionSize = &quot;$([Math]::Round(($fileVersionSize/1MB),3)) MB&quot;
                    $elementFile.VersionCount = $fileversions.Count
                    $totalVersionSize += $fileVersionSize
                    $elementFile.EndTime = (Get-Date).toString(&quot;dd-MM-yyyy HH:mm:ss&quot;)
                    $arrayFile.Add($elementFile) | Out-Null 
                }        
            }
        }
        $fileSizes += $fileSize
        $fileSizes += $totalVersionSize   

        return $fileSizes
    }
    catch {
        Write-Output &quot;An exception was thrown: $($_.Exception.Message)&quot; -ForegroundColor Red
    } 
}

# Get total storage use for the site collection, amend query to run reports against site collection(s), e.g. filter by $_.StorageUsageCurrent -gt 10000
Get-PnPTenantSite -Connection $conn | Where-Object { ($_.Template -eq &quot;GROUP#0&quot; -or $_.Template -eq &quot;SITEPAGEPUBLISHING#0&quot;) -and $_.Title -eq &quot;Company 311&quot;} | ForEach-Object {
    $site = $_
    $siteStorage = $site.StorageUsageCurrent
    #$siteStorage = $siteStorage/1024l
    #$siteStorage = [Math]::Round($siteStorage, 2)
    Write-Host &quot;Site storage: $siteStorage MB&quot;
    $siteconn = Connect-PnPOnline -Url $site.Url -Interactive -ReturnConnection

    $element = &quot;&quot; | Select-Object SiteUrl, siteName, siteStorage, FileSize, StartTime,TotalVersionSize, RecycleBinSize,EndTime
    $element.SiteUrl = $site.Url
    $element.siteName = $site.Title
    $element.siteStorage = &quot;$siteStorage MB&quot;
    $element.StartTime = (Get-Date).toString(&quot;dd-MM-yyyy HH:mm:ss&quot;)
    $FileSizeVersions = ReportStorageVersions -site $site
    $element.FileSize = &quot;$([Math]::Round(($FileSizeVersions[0]/1MB),3)) MB&quot; 
    $element.TotalVersionSize = &quot;$([Math]::Round(($FileSizeVersions[1]/1MB),3)) MB&quot;
    $RecycleBinItemsSize = Get-PnPRecycleBinItem -Connection $siteconn | Measure-Object -Property Size -Sum | Select-Object -ExpandProperty Sum
    $element.RecycleBinSize = &quot;$([Math]::Round(($RecycleBinItemsSize/1MB),3)) MB&quot;
    $element.EndTime = (Get-Date).toString(&quot;dd-MM-yyyy HH:mm:ss&quot;)

    $arraySite.Add($element) | Out-Null 
}  

$arraySite | Export-Csv -Path $OutputSite -NoTypeInformation -Force 
$arrayFile | Export-Csv -Path $OutputFile -NoTypeInformation -Force

</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>PnP PowerShell</strong> to learn more at: <a href="https://aka.ms/pnp/powershell">https://aka.ms/pnp/powershell</a></p>
</div>
<div class="highlight-tool">
<p>The way you login into PnP PowerShell has changed please read <a href="https://github.com/pnp/powershell/discussions/4249">PnP Management Shell EntraID app is deleted : what should I do ?</a></p>
</div>
</section>
</div>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/reshmee011">Reshmee Auckloo</a></td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/spo-get-storage-site-versionsrecyclebin" aria-hidden="true">
</article>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    
    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>