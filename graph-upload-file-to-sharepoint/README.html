<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <title>Uploads a large file to SharePoint using MS Graph REST API and PowerShell | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="Uploads a large file to SharePoint using MS Graph REST API and PowerShell | PnP Samples ">
    <meta name="generator" content="docfx 2.56.7.0">
    <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Uploads a large file to SharePoint using MS Graph REST API and PowerShell | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
    <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>    </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/graph-upload-file-to-sharepoint/README.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="uploads-a-large-file-to-sharepoint-using-ms-graph-rest-api-and-powershell">Uploads a large file to SharePoint using MS Graph REST API and PowerShell</h1>

<h2 id="summary">Summary</h2>
<p>This script allows you to upload a large file to SharePoint using MS Graph API Rest Call.</p>
<p>The script uses <a href="https://learn.microsoft.com/graph/api/driveitem-createuploadsession">DriveItem: createUploadSession</a>, which uploads the file in chunks. Maximum size a chunk can be is 60 MiB, however in this example, it breaks the file into 1.31 MiB.</p>
<p>The script will overwrite the file if it already exists in the SharePoint library, or you can provide an alternative name for the file.</p>
<p>The script does not handle possible errors.</p>
<h3 id="pre-requisites">Pre-requisites</h3>
<p>You can use either a user account that is minimum of a member of the SharePoint site.<br>
Sign in:</p>
<pre><code class="lang-powershell">az login --use-device-code --allow-no-subscriptions
</code></pre>
<p>Alternatively, create an App Registration and secret with <strong><em>'Microsoft Graph - Sites.ReadWrite.All'</em></strong> Application permission.</p>
<pre><code class="lang-powershell">az login --service-principal `
 -u &lt;APPID&gt; `
 -p &lt;SECRET&gt; `
 --tenant &lt;TENANTID&gt; --allow-no-subscriptions
</code></pre>
<h3 id="screenshots">Screenshots</h3>
<p><em>Image1: Empty SharePoint Library</em></p>
<p><img src="assets/SharePointLibrary.png" alt="SharePointLibrary"></p>
<p><em>Image2: File sitting in local folder around 9 Megabytes in size.</em></p>
<p><img src="assets/FileToUpload.png" alt="FileUpload"></p>
<p><em>Image3: Uploading file to SharePoint</em></p>
<p><img src="assets/Uploading.png" alt="FileUploading"></p>
<p><em>Image4: Files uploaded as user and App Registration</em></p>
<p><img src="assets/AfterUpload.png" alt="AfterUpload"></p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_azure-cli" role="tab" aria-controls="tabpanel_CeZOj-G++Q_azure-cli" data-tab="azure-cli" tabindex="0" aria-selected="true">Azure CLI</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_azure-cli" role="tabpanel" data-tab="azure-cli">

<ul>
<li>Save the following script as &quot;Add-FileToSharePoint.ps1&quot;</li>
<li>Log into Az Cli as User or App Registration Service Principal</li>
<li>Call <code>.\Add-FileToSharePoint.ps1</code> passing in the relevant parameters.</li>
</ul>
<pre><code class="lang-powershell">&lt;#
.SYNOPSIS
    Uploads/overwrite the given file to the given location in SharePoint.
.DESCRIPTION
    Uploads/overwrite the given file to the given location in SharePoint.
.PARAMETER TenantName
    The SharePoint Tenant name, before .sharepoint.com.
.PARAMETER SiteServerRelativeUrl
    RelativePath to SharePoint Site.
.PARAMETER LibraryName
    Name of the Library within the SharePoint site to upload file to.
.PARAMETER FileToUpload
    Full path of the file to Upload
.PARAMETER SharePointRelativeFolderPath
    (Optional) Relative from root library Folder, if left blank will upload to root of library.
.PARAMETER AlternativeFileName
    (Optional) To save the file with a different name.

.EXAMPLE 
    Upload file to SharePoint.
        Add-FileToSharePoint.ps1 `
            -TenantName:contso `
            -SiteServerRelativeUrl:&quot;/sites/uploadfiles&quot; `
            -LibraryName:&quot;Documents&quot; `
            -PathFileToUpload:&quot;c:\upload\PNP Script Samples Rock.docx&quot; `
            -SharePointRelativeFolderPath: &quot;/PNP/Word Docs/&quot; 

.EXAMPLE 
    Upload file to SharePoint with different name.
        Add-FileToSharePoint.ps1 `
            -TenantName:contso `
            -SiteServerRelativeUrl:&quot;/sites/uploadfiles&quot; `
            -LibraryName:&quot;Documents&quot; `
            -PathFileToUpload:&quot;c:\upload\PNP Script Samples Rock.docx&quot; `
            -SharePointRelativeFolderPath: &quot;/PNP/Word Docs/&quot; `
            -AlternativeFileName:&quot;Renamed Script Samples Rock.docx&quot;

.LINK
    https://learn.microsoft.com/graph/api/driveitem-createuploadsession
#&gt;
[CmdletBinding(SupportsShouldProcess)]
param (
    [Parameter(Mandatory = $true)]
    [string]
    $TenantName,

    [Parameter(Mandatory = $true)]
    [string]
    $SiteServerRelativeUrl,

    [Parameter(Mandatory = $true)]
    [string]
    $LibraryName,

    [Parameter(Mandatory = $true)]
    [string]
    $PathFileToUpload,

    [Parameter(Mandatory = $false)]
    [string]
    $SharePointRelativeFolderPath = &quot;&quot;,

    [Parameter(Mandatory = $false)]
    [string]
    $AlternativeFileName = &quot;&quot;
)

Write-Host &quot;Getting Site ID for $SiteServerRelativeUrl...&quot;
$siteId = $(az rest --method get --url &quot;https://graph.microsoft.com/v1.0/sites/$TenantName.sharepoint.com:$($SiteServerRelativeUrl)?`$select=id&quot; | ConvertFrom-Json).id

Write-Host &quot;Getting Drive ID for the Library:$LibraryName...&quot;
$driveId = $((az rest --method get --url &quot;https://graph.microsoft.com/v1.0/sites/$SiteId/drives?`$select=id,name&quot; | ConvertFrom-Json).value | Where-Object { $_.name -eq $LibraryName }).id

Write-Host &quot;Getting Library Path and Name...&quot;
if ($AlternativeFileName) {
    $name = $AlternativeFileName
}
else {
    $Path = $PathFileToUpload.Replace('\', '/')
    $name = $Path.Substring($Path.LastIndexOf(&quot;/&quot;) + 1)
}

$uploadPath = $SharePointRelativeFolderPath + &quot;/$name&quot;
if (-not $uploadPath.StartsWith('/')) {
    $uploadPath = &quot;/&quot; + $uploadPath
}

Write-Host &quot;Creating an upload session...&quot;
$uploadSessionUri = &quot;https://graph.microsoft.com/v1.0/sites/$siteId/drives/$driveId/root:$($uploadPath):/createUploadSession&quot;
Write-Host &quot;Upload Session URI: $uploadSessionUri&quot;
$uploadSession = az rest --method post --url $uploadSessionUri --headers Content-Type=application/json | ConvertFrom-Json

Write-Host &quot;Getting local file...&quot;
$fileInBytes = [System.IO.File]::ReadAllBytes($PathFileToUpload)
$fileLength = $fileInBytes.Length

##################################################################################
# NOTES:              
# ------                                                           
#
# You can upload the entire file, or split the file into multiple byte ranges, as 
# long as the maximum bytes in any given request is less than 60 MiB.
#
# If your app splits a file into multiple byte ranges, 
# the size of each byte range MUST be a multiple of 320 KiB (327,680 bytes). 
# Using a fragment size that does not divide evenly by 320 KiB will result in 
# errors committing some files.
#
##################################################################################
$partSizeBytes = 320 * 1024 * 4  #Uploads 1.31MiB at a time.
$index = 0
$start = 0
$end = 0

$maxloops = [Math]::Round([Math]::Ceiling($fileLength / $partSizeBytes))

while ($fileLength -gt ($end + 1)) {
    $start = $index * $partSizeBytes
    if (($start + $partSizeBytes - 1 ) -lt $fileLength) {
        $end = ($start + $partSizeBytes - 1)
    }
    else {
        $end = ($start + ($fileLength - ($index * $partSizeBytes)) - 1)
    }
    [byte[]]$body = $fileInBytes[$start..$end]
    $headers = @{    
        'Content-Range' = &quot;bytes $start-$end/$fileLength&quot;
    }
    Write-Host &quot;bytes $start-$end/$fileLength | Index: $index and ChunkSize: $partSizeBytes&quot;
    Invoke-WebRequest -Method Put -Uri $uploadSession.uploadUrl -Body $body -Headers $headers -SkipHeaderValidation | Out-Null
    $index++
    Write-Host &quot;Percentage Complete: $([Math]::Ceiling($index/$maxloops*100)) %&quot;
}
</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>Azure CLI</strong> to learn more at: <a href="https://learn.microsoft.com/cli/azure/">https://learn.microsoft.com/cli/azure/</a></p>
</div>
</section>
</div>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/pmatthews05">Paul Matthews</a></td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/graph-upload-file-to-sharepoint" aria-hidden="true">
</article>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    
    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>