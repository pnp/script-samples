<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <title>Sample showing how to ensure that the Role/Title in each People web part is updated | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" "="">
    <meta name="title" content="Sample showing how to ensure that the Role/Title in each People web part is updated | PnP Samples ">
    <meta name="generator" content="docfx 2.56.7.0">
    <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Sample showing how to ensure that the Role/Title in each People web part is updated | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
    <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>    </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/spo-update-people-web-part/README.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="sample-showing-how-to-ensure-that-the-roletitle-in-each-people-web-part-is-updated">Sample showing how to ensure that the Role/Title in each People web part is updated</h1>

<h2 id="summary">Summary</h2>
<p>Not entirely sure if the Role/Title field shown in the People Web part is supposed to be updated by MS on some sort of schedule. If that is the case this trigger either has an error or takes forever to be triggered.</p>
<h2 id="implementation">Implementation</h2>
<ul>
<li>Open VS Code</li>
<li>Create a new file</li>
<li>Copy the code below,</li>
<li>Change the variables to target to your environment</li>
<li>Run the script.</li>
</ul>
<h2 id="screenshot-of-output">Screenshot of Output</h2>
<p><img src="assets/preview.png" alt="Example Screenshot"></p>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_pnpps" role="tab" aria-controls="tabpanel_CeZOj-G++Q_pnpps" data-tab="pnpps" tabindex="0" aria-selected="true">PnP PowerShell</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_pnpps" role="tabpanel" data-tab="pnpps"><button class="article-clipboard" title="Copy to clipboard" data-toggle="tooltip" data-placement="top" data-clipboard-target="section[id^='tabpanel'][data-tab='pnpps'] pre">
    <span class="glyphicon glyphicon-copy" aria-hidden="true"></span>
    <span class="article-clipboard__message done">Copied</span>
</button>

<pre><code class="lang-powershell">
# Author Kasper Larsen Fellowmind.dk
# Purpose : locate any People Web part and update those where the users title does not match the User profile anymore


#define which site collections you wish to iterate
$tenentUrl = &quot;https://[YourTenant].sharepoint.com&quot;
$conn = Connect-PnPOnline -Url $tenentUrl -Interactive -ReturnConnection
$relevantsitecollections = Get-PnPTenantSite | Where-Object {$_.Url -eq &quot;https://[YourTenant].sharepoint.com/sites/HubsiteA&quot;}

$SPAdminUrl = &quot;https://[YourTenant]-admin.sharepoint.com/&quot;
$spAdminConn = Connect-PnPOnline -Url $SPAdminUrl -Interactive -ReturnConnection

$Output = @()

function UpdatePeopleWebPart ($theWebpart, $page, $pageUrl)
{
    #$pageObj = Get-PnPPage -Identity $page[&quot;FileLeafRef&quot;]

    $props =  $thewebpart.PropertiesJson | ConvertFrom-Json
    $layout = $props.layout
    $persons = $props.persons
    $webpartTitle = $props.title

    foreach($person in $props.persons)
    {
        $User = Get-PnPUserProfileProperty -Account $person.id -Connection $spAdminConn
        $currentJobTitle = $User.UserProfileProperties[&quot;SPS-JobTitle&quot;]
        $oldrole = $person.role
        if($currentJobTitle -ne $person.role)
        {
            $person.role = $currentJobTitle
            $myObject = [PSCustomObject]@{
                URL     = $pageUrl
                personid = $person.id
                personupn = &quot;&quot;
                errorcode = &quot;Role has been updated from $oldrole to $currentJobTitle&quot;
        
            }        
            $Output+=($myObject)
        }
    }

    

    $thewebpart.PropertiesJson = $props | ConvertTo-Json
    $null = $page.Save()
    $null = $page.Publish()

    
}

foreach($site in  $relevantsitecollections)
{
    $sitecollectionUrl = $site.Url
    Write-Host &quot;Url =  $sitecollectionUrl&quot; -ForegroundColor Yellow
    
    $localConn = Connect-PnPOnline -Url $sitecollectionUrl -Interactive -ReturnConnection
    $pages = Get-PnPListItem -List &quot;sitePages&quot; -Connection $localConn

    foreach($page in $pages)
    {
        try 
        {
            $fullUrl = $tenentUrl+$page[&quot;FileRef&quot;]
            Write-Host &quot; Page = $fullUrl&quot; -ForegroundColor Green
            $webpartpage = Get-PnPClientSidePage -Identity $page[&quot;FileLeafRef&quot;] -ErrorAction Stop -Connection $localConn
            
            $webparts = $webpartpage.controls | Where-Object {$_.PropertiesJson -like &quot;*persons*&quot;}

            foreach($webpart in $webparts)
            {
                $props =  $webpart.PropertiesJson | ConvertFrom-Json
                write-host &quot;Found $props.persons.count people in the web part&quot; -ForegroundColor Blue

                $ShouldPeopleWebPartBeupdated = $false # checking if the Title of the users match the value from the User Profile 
                foreach($person in $props.persons)
                {
                    if(-not $ShouldPeopleWebPartBeupdated)
                    {
                        $User = Get-PnPUserProfileProperty -Account $person.id -Connection $spAdminConn
                        $currentJobTitle = $User.UserProfileProperties[&quot;SPS-JobTitle&quot;]
    
                        if($currentJobTitle -ne $person.role)
                        {
                            Write-Host &quot;The user $($person.Id) currently has a role as $($person.role) but the User Profile JobTitle is $currentJobTitle&quot; -ForegroundColor Red
                            $ShouldPeopleWebPartBeupdated = $true
                        }
                    }
                }
                if($ShouldPeopleWebPartBeupdated)
                {
                    UpdatePeopleWebPart -theWebpart $webpart -page $webpartpage -pageUrl $fullUrl
                }
            }
        }
        catch 
        {
            $myObject = [PSCustomObject]@{
                URL     = $tenentUrl+$page[&quot;FileRef&quot;]
                personid = &quot;&quot;
                personupn = &quot;&quot;
                errorcode = $_.Exception.Message

            }        
            $Output+=($myObject)
        }
        
        
        
        
    }
}
$Output | Export-Csv  -Path c:\temp\PeopleWebPartHasBeenUpdated.csv -Encoding utf8NoBOM -Force  -Delimiter &quot;|&quot;


</code></pre>
<div class="highlight-tool">
<p>Check out the <strong>PnP PowerShell</strong> to learn more at: <a href="https://aka.ms/pnp/powershell">https://aka.ms/pnp/powershell</a></p>
</div>
</section>
</div>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kasper Larsen, Fellowmind</td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/spo-update-people-web-part" aria-hidden="true">
</article>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    
    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>