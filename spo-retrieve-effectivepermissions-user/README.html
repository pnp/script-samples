<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <title>Retrieve Effective Permissions of End Users Across Sites | PnP Samples </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" "="">
    <meta name="title" content="Retrieve Effective Permissions of End Users Across Sites | PnP Samples ">
    <meta name="generator" content="docfx 2.56.7.0">
    <meta name="description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <!-- Social Media -->
    <meta property="og:locale" content="en_GB">
    <meta property="og:title" content="Retrieve Effective Permissions of End Users Across Sites | PnP Samples ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pnp.github.io/script-samples">
    <meta property="og:image" content="https://pnp.github.io/script-samples/assets/social-media-screenshot.png">
    <meta property="og:image:alt" content="Screenshot example of the PnP Script Samples Site">
    <meta property="og:site_name" content="PnP Script Samples">
    <meta name="msvalidate.01" content="04EFEDA66EC42C08A1247C979E2F9ADD">
    <meta property="og:description" content="A sample gallery of scripts to manage all things Microsoft 365.">
  
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/extra.css">
    <link rel="stylesheet" href="../styles/filter.css">
    <link rel="stylesheet" href="../styles/site.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    <meta property="docfx:newtab" content="true">
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "8j6pedl344");
  </script>
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
             <div class="github-mark">
              <a href="https://github.com/pnp/script-samples" title="Go to repository">
               <div class="github-wrapper">
                  <div class="github-icon">
                    <img src="https://pnp.github.io/script-samples/assets/icons/github-light-64px.png" alt="GitHub Icon Image">
                  </div>
                  <div class="github-repository">
                    <span>GitHub</span>
                    <ul class="github-facts">
                      <li>
                        <i class="fa fa-code-fork" aria-hidden="true"></i>
                        <span class="github-forks"></span>
                      </li>
                      <li>
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                        <span class="github-stars"></span>
                      </li>
                    </ul>
                  </div>
                </div>
              </a>
            </div>
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../assets/logo.svg" alt="">
              </a>    </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <label class="glyphicon glyphicon-search" for="search-query"></label>
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
                  <div class="contribution-panel mobile-hide pull-right">
                      <a href="https://github.com/pnp/script-samples/blob/main/scripts/spo-retrieve-effectivepermissions-user/README.md/#L1" title="Improve this Doc" class="improve-doc-lg"><i class="glyphicon glyphicon-pencil"></i></a>
                  </div>
                    <h1 id="retrieve-effective-permissions-of-end-users-across-sites">Retrieve Effective Permissions of End Users Across Sites</h1>

<h2 id="summary">Summary</h2>
<p>Managing permissions in SharePoint can be challenging, especially when users are granted access through various means such as direct permissions, shared links, SharePoint groups, or M365 groups. To simplify this process, you can use the effectivepermissions endpoint to retrieve and analyze permissions assigned to users at the site, list/library, and item/file/folder levels.</p>
<p><img src="assets/example.png" alt="Example Screenshot"></p>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li><p>The user account that runs the script must have SharePoint Online tenant administrator access.</p>
</li>
<li><p>Enter the values as prompted by the script and modify the filter <code>$m365Sites = Get-PnPTenantSite| Where-Object {  $_.Url -like '*/sites/*' -and $_.Template -ne 'RedirectSite#0' }</code>  to target only sites you are interested in.</p>
</li>
</ul>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_pnpps" role="tab" aria-controls="tabpanel_CeZOj-G++Q_pnpps" data-tab="pnpps" tabindex="0" aria-selected="true">PnP PowerShell</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_pnpps" role="tabpanel" data-tab="pnpps"><button class="article-clipboard" title="Copy to clipboard" data-toggle="tooltip" data-placement="top" data-clipboard-target="section[id^='tabpanel'][data-tab='pnpps'] pre">
    <span class="glyphicon glyphicon-copy" aria-hidden="true"></span>
    <span class="article-clipboard__message done">Copied</span>
</button>

<pre><code class="lang-powershell">#Parameters
$tenantUrl = Read-Host -Prompt &quot;Enter tenant URL&quot;;
$dateTime = (Get-Date).toString(&quot;dd-MM-yyyy-hh-ss&quot;)
$invocation = (Get-Variable MyInvocation).Value
$directorypath = Split-Path $invocation.MyCommand.Path
$fileName = &quot;EffectivePermissionsReport-&quot; + $dateTime + &quot;.csv&quot;
$ReportOutput = $directorypath + &quot;\Logs\&quot;+ $fileName
$userName =  Read-Host -Prompt &quot;Enter User Name&quot;;
#Connect to PnP Online
Connect-PnPOnline -Url $tenantUrl 

$global:Results = @();
Function Extract-Guid ($inputString) {
    $splitString = $inputString -split '\|'
    return $splitString[2].TrimEnd('_o')
  }
Function QueryUniquePermissionsByObject($_web,$_object,$_LoginName)
{
  $roleAssignments = Get-PnPProperty -ClientObject $_object -Property RoleAssignments
 $permissions =@(); 
  foreach($roleAssign in $roleAssignments){
    Get-PnPProperty -ClientObject $roleAssign -Property RoleDefinitionBindings,Member;
    $PermissionLevels = $roleAssign.RoleDefinitionBindings | Select -ExpandProperty Name;
    #Get all permission levels assigned (Excluding:Limited Access)  
    if($excludeLimitedAccess -eq $true){
       $PermissionLevels = ($PermissionLevels | Where { $_ -ne &quot;Limited Access&quot;}) -join &quot;,&quot;  
    }
    $Users = Get-PnPProperty -ClientObject ($roleAssign.Member) -Property Users -ErrorAction SilentlyContinue
    #Get Access type
    $AccessType = $roleAssign.RoleDefinitionBindings.Name
    $MemberType = $roleAssign.Member.GetType().Name; 
    #Get the Principal Type: User, SP Group, AD Group  
    $PermissionType = $roleAssign.Member.PrincipalType  
    If($PermissionLevels.Length -gt 0) {
      $MemberType = $roleAssign.Member.GetType().Name; 
       #Sharing link is in the format SharingLinks.03012675-2057-4d1d-91e0-8e3b176edd94.OrganizationView.20d346d3-d359-453b-900c-633c1551ccaa

      # c:0-.f|rolemanager|spo-grid-all-users/
        If ($roleAssign.Member.Title -like &quot;SharingLinks*&quot;)
        {
            If ($Users.count -gt 0)
            {
                $Users  | where-object {$_.LoginName -eq $_LoginName -or $_.Title -match 'Everyone except external users|Everyone|All Users'} | foreach-object{
             
                $permissions +=  New-Object PSObject -property $([ordered]@{
                    PermissionLevels = $AccessType
                    Type = $roleAssign.Member.Title
                 });
                }
            }
            else {
             
                $permissions +=  New-Object PSObject -property $([ordered]@{
                  PermissionLevels = $AccessType
                  Type = $roleAssign.Member.Title
               });
           # }
            }      
            
        }
      ElseIf($MemberType -eq &quot;User&quot;)
      { 
        $MemberName = $roleAssign.Member.Title; 
        $MemberLoginName = $roleAssign.Member.LoginName;    
        if($MemberType -eq &quot;User&quot;  -and  ($roleAssign.Member.LoginName -eq $_LoginName -or $_.Title -eq 'Everyone except external users'))
        {
          $ParentGroup = &quot;Direct&quot;;
        
        # (PermissionObject $_object $_Type $_RelativeUrl $_siteUrl $_siteTitle $_listTitle $MemberType $ParentGroup $MemberName $MemberLoginName $PermissionLevels); 
        $permissions +=  New-Object PSObject -property $([ordered]@{
            PermissionLevels =  $PermissionLevels -Join &quot;,&quot;
            Type= &quot;Direct&quot;
        });
       }
      }
      elseif($MemberType -eq &quot;Group&quot;)
      {}

      if( $MemberType -eq &quot;Group&quot;)
      {
        If($PermissionType -eq &quot;SharePointGroup&quot;)  {  
          #Get Group Members  
          $groupUsers = Get-PnPGroupMember -Identity $roleAssign.Member.LoginName                  
          $groupUsers|foreach-object{ 
            if ($_.LoginName.StartsWith(&quot;c:0o.c|federateddirectoryclaimprovider|&quot;) -and $_.LoginName.EndsWith(&quot;_0&quot;)) {
              $guid = Extract-Guid $_.LoginName
              
              Get-PnPMicrosoft365GroupOwners -Identity $guid |where-object {$_.LoginName -eq $_LoginName}  |ForEach-Object {
                $user = $_ 
                $permissions +=  New-Object PSObject -property $([ordered]@{
                    PermissionLevels =  $PermissionLevels -Join &quot;,&quot;
                    Type= $roleAssign.Member.LoginName
                 });  
            }
            }
            elseif ($_.LoginName.StartsWith(&quot;c:0o.c|federateddirectoryclaimprovider|&quot;)) {
              $guid = Extract-Guid $_.LoginName
              
              Get-PnPMicrosoft365GroupMembers -Identity $guid | where-object {$_.LoginName -eq $_LoginName} |ForEach-Object {
                $user = $_
                $permissions +=  New-Object PSObject -property $([ordered]@{
                    PermissionLevels =  $PermissionLevels -Join &quot;,&quot;
                    Type= $roleAssign.Member.LoginName
                 });  
              }
            }
            if ($_.LoginName -eq $_LoginName -or $_.Title -match 'Everyone except external users|Everyone|All Users'){  
                $permissions +=  New-Object PSObject -property $([ordered]@{
                    PermissionLevels = $PermissionLevels -Join &quot;,&quot;
                    Type= $roleAssign.Member.LoginName
                 });   
            }


          }
        }
      } 
    }      
  }
return $permissions;
}

function GetUserEffectivePermissions($_ctx,$_object,$_userName,$_type,$_siteUrl,$_listUrl)
{
    $user = get-pnpuser -Identity $_userName

     # Retrieve the user permissions on the site
     if($user){
     $permissions = $_object.GetUserEffectivePermissions($user.LoginName)
     $_ctx.ExecuteQuery()
     #get all base permissions granted to the user
     $PermissionKindObj= New-Object Microsoft.SharePoint.Client.PermissionKind 
     $PermissionKindType=$PermissionKindObj.getType()
     $permissionsToExport = @()
     ForEach ($PermissionKind in [System.Enum]::GetValues($PermissionKindType))
     {
         $hasPermisssion = $permissions.Value.Has($PermissionKind)
         if ($hasPermisssion -and $permissionKind.ToString() -ne 'EmptyMask')
         {
             $permissionsToExport +=$permissionKind.ToString()                   
         }
     }
     
     if($permissionsToExport){
       $permissions= QueryUniquePermissionsByObject $_ctx.web $_object $user.LoginName
     
     
     if($_type -eq &quot;File&quot;)
        {
            $ObjectType = $item.FileSystemObjectType; 
            $Name  = $Item.FieldValues[&quot;FileLeafRef&quot;]           
            $RelativeURL = $Item.FieldValues[&quot;FileRef&quot;]
        }
        else
        {
            $ObjectType = $_type;
            $Name = &quot;&quot;;
            $RelativeURL = $_listUrl ?? 
            $SiteUrl;
        }

        #find out how permissions have been granted - direct, group , sharing links

        $result = New-Object PSObject -property $([ordered]@{
            SiteUrl = $_siteURL
            listUrl = $_listUrl
            Name  = $Name           
            RelativeURL = $RelativeURL
            ObjectType = $ObjectType
            User = $User.LoginName
            EffectivePermissions =  ($permissionsToExport -join &quot;,&quot;)
            GivenThroughGranted =  ($permissions | foreach-object{ $_.type}) -join ','
        }) 
        $global:Results +=$result;
    }
  }
}

#Exclude certain libraries
$ExcludedLists = @(&quot;Form Templates&quot;, &quot;Preservation Hold Library&quot;, &quot;Site Assets&quot;, &quot;Images&quot;, &quot;Pages&quot;, &quot;Settings&quot;, &quot;Videos&quot;,&quot;Timesheet&quot;
    &quot;Site Collection Documents&quot;, &quot;Site Collection Images&quot;, &quot;Style Library&quot;, &quot;AppPages&quot;, &quot;Apps for SharePoint&quot;, &quot;Apps for Office&quot;)

$m365Sites = Get-PnPTenantSite| Where-Object {  $_.Url -like '*/sites/*' -and $_.Template -ne 'RedirectSite#0' } 
#$m365Sites = Get-PnPTenantSite -Detailed | Where-Object {($_.Url -like '*Comm*') -and $_.Template -ne 'RedirectSite#0' }
$m365Sites | ForEach-Object {
$siteUrl = $_.Url;     
Connect-PnPOnline -Url $siteUrl 
$ctx = Get-PnPContext
$web= Get-PnPWeb

Write-Host &quot;Processing site $siteUrl&quot;  -Foregroundcolor &quot;Red&quot;; 

GetUserEffectivePermissions $ctx $web $userName &quot;site&quot; $siteUrl &quot;&quot;;
$ll = Get-PnPList -Includes BaseType, Hidden, Title,HasUniqueRoleAssignments,RootFolder | Where-Object {$_.Hidden -eq $False -and $_.Title -notin $ExcludedLists } #$_.BaseType -eq &quot;DocumentLibrary&quot; 
  Write-Host &quot;Number of lists $($ll.Count)&quot;;

  foreach($list in $ll)
  {
    $listUrl = $list.RootFolder.ServerRelativeUrl;       

    #Get all list items in batches
    $ListItems = Get-PnPListItem -List $list -PageSize 2000 
    if($list.HasUniqueRoleAssignments)
    {
      GetUserEffectivePermissions $ctx $list $userName &quot;list/library&quot; $siteUrl $listUrl;
    }
        #Iterate through each list item
        ForEach($item in $ListItems)
        {
            $ItemCount = $ListItems.Count
            #Check if the Item has unique permissions
            $HasUniquePermissions = Get-PnPProperty -ClientObject $Item -Property &quot;HasUniqueRoleAssignments&quot;
            If($HasUniquePermissions)
            {       
                #Get Shared Links
                if($list.BaseType -eq &quot;DocumentLibrary&quot;)
                {
                    $type= &quot;File&quot;;
                }
                else
                {
                    $type= &quot;Item&quot;;
                }
                GetUserEffectivePermissions $ctx $item $userName $type $siteUrl $listUrl;
            }
        }
    }
 }
  $global:Results | Export-CSV $ReportOutput -NoTypeInformation
Write-host -f Green &quot;Effective Permissions for user generated Successfully!&quot;
</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>SharePoint admin rights are required to run the script</p>
</div>
<div class="highlight-tool">
<p>Check out the <strong>PnP PowerShell</strong> to learn more at: <a href="https://aka.ms/pnp/powershell">https://aka.ms/pnp/powershell</a></p>
</div>
<div class="highlight-tool">
<p>The way you login into PnP PowerShell has changed please read <a href="https://github.com/pnp/powershell/discussions/4249">PnP Management Shell EntraID app is deleted : what should I do ?</a></p>
</div>
</section>
</div>
<h2 id="source-credit">Source Credit</h2>
<p>Sample first appeared on <a href="https://reshmeeauckloo.com/posts/powershell-get-effectivepermissions-for-site-list-item/">Retrieve Effective Permissions of an user within SharePoint Sites Using PowerShell</a></p>
<h2 id="contributors">Contributors</h2>
<table>
<thead>
<tr>
<th>Author(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/reshmee011">Reshmee Auckloo</a></td>
</tr>
</tbody>
</table>
<h2 id="disclaimer">Disclaimer</h2>
<p><strong>THESE SAMPLES ARE PROVIDED <em>AS IS</em> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR NON-INFRINGEMENT.</strong></p>
<img src="https://m365-visitor-stats.azurewebsites.net/script-samples/scripts/spo-retrieve-effectivepermissions-user" aria-hidden="true">
</article>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Script Samples<br>Generated by <strong><a href='https://dotnet.github.io/docfx' alt='Doc FX Website'>DocFX</a></strong> with <strong><a href='https://ovasquez.github.io/docfx-material' alt='DocFx Material Theme'>Material UI</a></strong></span>
            
            <!-- <img src="https://telemetry.sharepointpnp.com/@pnp.github.io/index/" alt="spacer"> -->
          </div>
        </div>
      </footer>    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
    
    <script type="text/javascript" src="../styles/clipboard.min.js"></script>
    <script type="text/javascript" src="../styles/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="../styles/loadsamples.js"></script>
    <script type="text/javascript" src="../styles/filtersamples.js"></script>

  </body>
</html>